<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Doce Sabor Caseiro - Gestão</title>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    /* Estilos Globais */
    * {
      box-sizing: border-box;
      font-family: 'Quicksand', sans-serif;
    }
    body {
      background: #fdf6f7; /* Um rosa bem clarinho */
      margin: 0;
      color: #333;
      line-height: 1.6;
    }

    /* Splash Screen */
    .splash {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(to bottom right, #ffb6c1, #f08080); /* Gradiente rosa-avermelhado */
      color: white;
      text-align: center;
      transition: opacity 1s ease-in-out;
      opacity: 1;
    }
    .splash.fade-out {
        opacity: 0;
        visibility: hidden; /* Oculta o elemento para que não seja interativo após o fade-out */
        transition: opacity 1s ease-in-out, visibility 1s ease-in-out;
    }
    .splash h1 {
      font-family: 'Pacifico', cursive; /* Fonte cursiva para o título */
      font-size: 4.5rem; /* Maior e mais impactante */
      margin-bottom: 25px;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }
    .splash button {
      background: white;
      color: #f08080;
      font-size: 1.4rem;
      border: none;
      padding: 15px 30px;
      border-radius: 50px; /* Botão arredondado */
      cursor: pointer;
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
    }
    .splash button:hover {
      background: #eee;
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }

    /* Layout Principal do App */
    .container {
      display: none;
      padding: 20px;
      max-width: 900px; /* Largura máxima para centralizar o conteúdo */
      margin: 0 auto; /* Centraliza */
    }

    /* Navegação */
    nav {
      display: flex;
      flex-wrap: wrap;
      justify-content: center; /* Centraliza os botões */
      background: #f08080; /* Cor mais forte para a nav */
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 1000; /* Garante que fique acima de outros elementos */
      border-radius: 10px; /* Bordas arredondadas na nav */
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      gap: 15px; /* Espaçamento entre botões */
    }
    nav button {
      background: none;
      border: none;
      color: white;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      padding: 10px 15px;
      border-radius: 8px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px; /* Espaço entre ícone e texto */
    }
    nav button:hover, nav button.active {
      background: rgba(255,255,255,0.2); /* Fundo sutil ao hover/ativo */
      transform: translateY(-2px);
    }
    nav button.active {
        box-shadow: inset 0 0 8px rgba(0,0,0,0.1); /* Sombra interna para o botão ativo */
    }


    /* Seções */
    section {
      display: none;
      background: white;
      padding: 25px;
      margin-top: 25px;
      border-radius: 15px; /* Bordas mais arredondadas */
      box-shadow: 0 5px 20px rgba(0,0,0,0.08); /* Sombra mais suave */
    }
    section.active {
      display: block;
    }
    h2 {
      color: #e91e63; /* Rosa mais vibrante para títulos */
      margin-bottom: 20px;
      border-bottom: 2px solid #f8bbd0; /* Linha sutil */
      padding-bottom: 8px;
      font-size: 1.8rem;
      text-align: center;
    }

    /* Formulários e Inputs */
    input, select, button.save {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px; /* Mais espaço entre campos */
      border: 1px solid #ccc;
      border-radius: 10px; /* Bordas arredondadas */
      font-size: 1rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    input:focus, select:focus {
      border-color: #f08080;
      box-shadow: 0 0 0 3px rgba(240, 128, 128, 0.2); /* Sombra ao focar */
      outline: none;
    }
    button.save {
      background: #f08080;
      color: white;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    button.save:hover {
      background: #e91e63;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    /* Botões de Ação (Editar, Excluir, Usar) */
    button.edit, button.delete, button.use {
        background: #ffc107; /* Amarelo para editar */
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        margin-left: 8px;
        font-size: 0.85em;
        transition: all 0.2s ease;
    }
    button.delete {
        background: #dc3545; /* Vermelho para excluir */
    }
    button.use {
        background: #6c757d; /* Cinza para usar */
    }
    button.edit:hover { background: #e0a800; transform: translateY(-1px); }
    button.delete:hover { background: #c82333; transform: translateY(-1px); }
    button.use:hover { background: #5a6268; transform: translateY(-1px); }

    /* Listas de Itens */
    ul {
      list-style: none;
      padding: 0;
      margin-top: 20px;
      max-height: 400px; /* Altura máxima para rolagem */
      overflow-y: auto;
      border-top: 1px solid #eee; /* Separador sutil */
      padding-top: 15px;
    }
    li {
      background: #fff0f5; /* Rosa claro para itens da lista */
      margin-bottom: 12px; /* Mais espaço entre itens */
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* Sombra mais pronunciada */
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap; /* Permite quebrar linha em telas pequenas */
      border: 1px solid #ffe6ec; /* Borda suave */
    }
    li .item-details {
        flex-grow: 1;
        font-size: 0.95rem;
        color: #555;
    }
    li .item-actions {
        display: flex;
        gap: 8px; /* Espaçamento entre os botões de ação */
        margin-top: 10px; /* Espaçamento caso quebre linha */
    }
    @media (min-width: 480px) {
        li .item-actions {
            margin-top: 0; /* Remove espaçamento se não quebrar linha */
        }
    }
    li strong {
        color: #e91e63;
    }

    /* Mensagens de Lista Vazia/Sem Resultados */
    .empty-list-message {
        text-align: center;
        color: #888;
        font-style: italic;
        padding: 20px;
        background: #f8f8f8;
        border-radius: 8px;
        margin-top: 20px;
    }

    /* Cores de status para estoque */
    .falta { background: #ffebee; border-color: #ef9a9a; } /* Vermelho bem claro */
    .falta .item-details { color: #d32f2f; font-weight: bold; }
    .baixo { background: #fffde7; border-color: #ffeb3b; } /* Amarelo bem claro */
    .baixo .item-details { color: #fbc02d; }
    .historico { font-size: 0.85rem; color: #777; }
    .historico li { background: #fdf6f7; border: none; box-shadow: none; padding: 8px 10px; }


    /* Estilos do Financeiro */
    .financeiro-summary {
        background: #ffe6ec;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        text-align: center;
    }
    .financeiro-summary p {
        font-size: 1.2em;
        margin-bottom: 10px;
        color: #555;
    }
    .financeiro-summary p strong {
        color: #e91e63;
    }
    #ganhos { color: #4caf50; font-weight: bold; } /* Verde para ganhos */
    #gastos { color: #f44336; font-weight: bold; } /* Vermelho para gastos */
    #lucros { color: #2196f3; font-weight: bold; } /* Azul para lucros */

    .financeiro-detail-toggle {
        background: #f08080;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 15px;
        margin-bottom: 15px;
        width: 100%;
        font-weight: bold;
        transition: background 0.3s ease, transform 0.3s ease;
    }
    .financeiro-detail-toggle:hover {
        background: #e91e63;
        transform: translateY(-2px);
    }
    .financeiro-list-container {
        max-height: 0; /* Inicia oculto com altura 0 */
        overflow: hidden;
        border: 1px solid #eee;
        border-radius: 10px;
        padding: 0 15px; /* Padding vertical 0 para ocultar */
        background: #fefefe;
        transition: max-height 0.5s ease-out, padding 0.5s ease-out; /* Transição suave */
        margin-top: 10px;
    }
    .financeiro-list-container.active {
        max-height: 400px; /* Altura máxima quando ativo (ajuste conforme necessário) */
        padding: 15px; /* Padding total quando ativo */
    }
    .financeiro-list-container h4 {
        color: #f08080;
        margin-top: 0;
        margin-bottom: 15px;
        border-bottom: 1px dashed #f8bbd0; /* Linha pontilhada */
        padding-bottom: 8px;
        font-size: 1.2em;
    }
    .financeiro-list-container ul {
        max-height: none; /* Sobrescreve o max-height para este ul específico */
        overflow-y: visible; /* Sobrescreve para este ul específico */
        padding-left: 0;
        border-top: none; /* Remove a borda superior para não duplicar */
    }
    .financeiro-list-container li {
        background: #ffe6f2; /* Cor mais clara para itens de detalhe */
        font-size: 0.9em;
        padding: 10px;
        margin-bottom: 8px;
        border: 1px solid #fce4ec;
    }
    .financeiro-filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .financeiro-filters select {
        flex: 1;
        min-width: 150px;
        margin-bottom: 0;
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .splash h1 { font-size: 3.5rem; }
      .splash button { font-size: 1.1rem; padding: 10px 20px; }
      nav { justify-content: space-around; gap: 8px; }
      nav button { font-size: 0.9rem; padding: 8px 10px; gap: 5px; }
      h2 { font-size: 1.5rem; }
      section { padding: 15px; margin-top: 15px; }
      input, select, button.save { padding: 10px; margin-bottom: 10px; }
      li { padding: 12px; }
      li .item-actions { width: 100%; justify-content: flex-end; } /* Alinha botões à direita em telas pequenas */
    }

    @media (max-width: 480px) {
      .splash h1 { font-size: 2.8rem; }
      nav { flex-direction: column; align-items: center; }
      nav button { width: 90%; margin-bottom: 5px; }
      .container { padding: 10px; }
      h2 { font-size: 1.3rem; }
    }
  </style>
</head>
<body>

  <div class="splash" id="splash">
    <h1>Doce Sabor Caseiro</h1>
    <button onclick="entrar()">Entrar</button>
  </div>

  <div class="container" id="app">
    <nav>
      <button id="navClientes" onclick="mostrar('clientes')"><i class="fa-solid fa-users"></i> Clientes</button>
      <button id="navPedidos" onclick="mostrar('pedidos')"><i class="fa-solid fa-cookie-bite"></i> Pedidos</button>
      <button id="navDespesas" onclick="mostrar('despesas')"><i class="fa-solid fa-sack-dollar"></i> Despesas</button>
      <button id="navEstoque" onclick="mostrar('estoque')"><i class="fa-solid fa-boxes-stacked"></i> Estoque</button>
      <button id="navFinanceiro" onclick="mostrar('financeiro')"><i class="fa-solid fa-chart-line"></i> Financeiro</button>
    </nav>

    <section id="clientes" class="active">
      <h2>Cadastro de Clientes</h2>
      <input id="clienteNome" placeholder="Nome Completo" type="text" />
      <input id="clienteTelefone" placeholder="Telefone (ex: 51999998888)" type="tel" pattern="[0-9]{11}" title="Telefone com 11 dígitos (DDD + número)" />
      <input id="clienteEndereco" placeholder="Endereço Completo" type="text" />
      <button class="save" onclick="salvarCliente()">Salvar Cliente</button>

      <input id="buscaCliente" placeholder="Buscar cliente por nome, telefone ou endereço..." oninput="listarClientes()" />
      <ul id="listaClientes"></ul>
    </section>

    <section id="pedidos">
      <h2>Registro de Pedidos</h2>
      <input id="pedidoCliente" placeholder="Nome do Cliente para o Pedido" type="text" />
      <input id="tipoProduto" placeholder="Tipo de Produto (ex: Bolo, Torta, Doce)" type="text" />
      <input id="valorPedido" type="number" step="0.01" min="0" placeholder="Valor Total (R$)" />
      <input id="dataEntrega" type="date" />
      <select id="formaEntrega">
        <option value="">Selecione a Forma de Entrega</option>
        <option value="Entregar">Entrega (Delivery)</option>
        <option value="Retirar">Retirada no Local</option>
      </select>
      <button class="save" onclick="salvarPedido()">Salvar Pedido</button>
      <ul id="listaPedidos"></ul>
    </section>

    <section id="despesas">
      <h2>Registro de Despesas</h2>

      <div style="background:#fff0f5; padding:20px; border-radius:15px; margin-bottom:20px; box-shadow:0 1px 6px rgba(0,0,0,0.05);">
        <label for="categoriaDespesa" style="display:block; margin-bottom:8px; font-weight:600; color:#e91e63;">Categoria:</label>
        <select id="categoriaDespesa" style="margin-bottom:12px;">
          <option value="">Selecione a Categoria</option>
          <option>Mercadorias</option>
          <option>Loja</option>
          <option>Pessoais</option>
          <option>Marketing</option>
          <option>Manutenção</option>
          <option>Outros</option>
        </select>

        <label for="descricaoDespesa" style="display:block; margin-bottom:8px; font-weight:600; color:#e91e63;">Descrição da Despesa:</label>
        <input type="text" id="descricaoDespesa" placeholder="Ex: Farinha de trigo, Aluguel, Propaganda..." />

        <label for="dataDespesa" style="display:block; margin-bottom:8px; font-weight:600; color:#e91e63;">Data da Despesa:</label>
        <input type="date" id="dataDespesa" />

        <label for="valorDespesa" style="display:block; margin-bottom:8px; font-weight:600; color:#e91e63;">Valor (R$):</label>
        <input type="number" step="0.01" min="0" id="valorDespesa" placeholder="0.00" />

        <button class="save" onclick="salvarDespesa()">Salvar Despesa</button>
      </div>

      <div style="margin-bottom:20px;">
        <label for="buscaDescricaoDespesa" style="font-weight:600; color:#e91e63;">Buscar Despesas:</label>
        <div style="display:flex; gap:10px; margin-top:8px;">
          <input
            type="text"
            id="buscaDescricaoDespesa"
            placeholder="Buscar por descrição..."
            style="flex:1;"
            onkeydown="if(event.key==='Enter'){filtrarDespesas()}"
          />
          <button
            onclick="filtrarDespesas()"
            style="background:#f08080; color:#fff; border:none; border-radius:10px; padding:10px 18px; cursor:pointer; font-weight:bold; transition:all 0.3s ease;"
          >
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
        </div>
      </div>

      <button
        id="btnVerDespesas"
        onclick="toggleListaDespesas()"
        style="background:#6c757d; color:#fff; padding:10px 20px; border:none; border-radius:10px; cursor:pointer; font-weight:bold; margin-bottom:15px; width:100%; transition:all 0.3s ease;"
      >
        <i class="fa-solid fa-eye"></i> Ver Todas as Despesas
      </button>

      <ul id="listaDespesas" style="display:none;"></ul>
    </section>

    <section id="estoque">
      <h2>Controle de Estoque</h2>
      <input id="produtoNome" placeholder="Nome do Produto/Ingrediente" type="text" />
      <select id="produtoTipo">
        <option value="">Selecione o Tipo</option>
        <option value="Ingrediente">Ingrediente</option>
        <option value="Embalagem">Embalagem</option>
        <option value="Produto Final">Produto Final</option>
      </select>
      <input id="produtoQtd" type="number" min="0" placeholder="Quantidade em Estoque" />
      <input id="produtoMin" type="number" min="0" placeholder="Quantidade Mínima Ideal" />
      <input id="produtoValidade" type="date" />
      <button class="save" onclick="adicionarProduto()">Adicionar/Atualizar Produto</button>

      <input id="buscaProduto" placeholder="Buscar produto por nome..." oninput="listarProdutos()" style="margin-top:20px;" />
      <select id="filtroTipoEstoque" onchange="listarProdutos()" style="margin-bottom:20px;">
        <option value="">Filtrar por Tipo (Todos)</option>
        <option value="Ingrediente">Ingrediente</option>
        <option value="Embalagem">Embalagem</option>
        <option value="Produto Final">Produto Final</option>
      </select>
      <ul id="listaEstoque"></ul>

      <h3>Histórico de Movimentações</h3>
      <ul id="listaHistorico" class="historico"></ul>
    </section>

    <section id="financeiro">
      <h2>Visão Financeira</h2>
      <div class="financeiro-filters">
        <select id="filtroMesFinanceiro" onchange="atualizarFinanceiro()">
          <option value="">Todos os Meses</option>
          <option value="01">Janeiro</option><option value="02">Fevereiro</option>
          <option value="03">Março</option><option value="04">Abril</option>
          <option value="05">Maio</option><option value="06">Junho</option>
          <option value="07">Julho</option><option value="08">Agosto</option>
          <option value="09">Setembro</option><option value="10">Outubro</option>
          <option value="11">Novembro</option><option value="12">Dezembro</option>
        </select>
        <select id="filtroAnoFinanceiro" onchange="atualizarFinanceiro()">
          <option value="">Todos os Anos</option>
          </select>
      </div>

      <div class="financeiro-summary">
        <p>
          <strong>Ganhos Totais:</strong> R$ <span id="ganhos">0.00</span>
        </p>
        <p>
          <strong>Gastos Totais:</strong> R$ <span id="gastos">0.00</span>
        </p>
        <p>
          <strong>Lucro/Prejuízo:</strong> R$ <span id="lucros">0.00</span>
        </p>
      </div>

      <button class="financeiro-detail-toggle" onclick="toggleDetalhesFinanceiros('ganhos')">
        <i class="fa-solid fa-circle-plus"></i> Detalhes dos Ganhos
      </button>
      <div id="detalhesGanhos" class="financeiro-list-container">
        <h4>Ganhos por Pedido</h4>
        <ul id="listaGanhosDetalhes"></ul>
      </div>

      <button class="financeiro-detail-toggle" onclick="toggleDetalhesFinanceiros('gastos')">
        <i class="fa-solid fa-circle-minus"></i> Detalhes dos Gastos
      </button>
      <div id="detalhesGastos" class="financeiro-list-container">
        <h4>Gastos por Despesa</h4>
        <ul id="listaGastosDetalhes"></ul>
      </div>
    </section>
  </div>

  <script>
    // --- Funções de Inicialização e Navegação ---

    function entrar() {
      const splash = document.getElementById('splash');
      const app = document.getElementById('app');
      splash.classList.add('fade-out'); // Adiciona classe para iniciar a transição
      setTimeout(() => {
        splash.style.display = 'none';
        app.style.display = 'block';
        preencherFiltrosAnoFinanceiro();
        atualizarTudo(); // Carrega todos os dados iniciais
      }, 900); // Tempo para a transição (um pouco menos que o tempo total da transição CSS)
    }

    function mostrar(secaoId) {
      // Remove 'active' de todas as seções e botões de navegação
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));

      // Adiciona 'active' à seção e botão clicado
      document.getElementById(secaoId).classList.add('active');
      document.getElementById(`nav${secaoId.charAt(0).toUpperCase() + secaoId.slice(1)}`).classList.add('active'); // Ex: navClientes

      // Certifica-se que as listas visíveis estão atualizadas ao mudar de seção
      if (secaoId === 'despesas') {
          // Se a lista de despesas estiver visível, recarrega-a
          if (document.getElementById('listaDespesas').style.display === 'block') {
              filtrarDespesas();
          }
      } else if (secaoId === 'estoque') {
          listarProdutos();
          listarHistorico();
      } else if (secaoId === 'financeiro') {
          atualizarFinanceiro();
      }
    }

    // --- Funções Genéricas de Edição e Exclusão ---

    /**
     * Função genérica para editar um item. Preenche o formulário com os dados do item
     * e informa o usuário que ele deve salvar novamente.
     * @param {string} key - A chave do localStorage (ex: 'clientes', 'pedidos').
     * @param {number} id - O índice do item na lista do localStorage.
     * @param {Array<Object>} formFields - Um array de objetos descrevendo os campos do formulário.
     * Ex: [{id: 'inputId', name: 'propertyName', type: 'text'|'number'|'date'|'select'}]
     * @param {Function} listFunction - A função de listar/atualizar a UI para essa seção.
     * @param {Function} itemToDisplay - Uma função que recebe o item e retorna uma string para exibir no prompt de confirmação.
     */
    function editarItem(key, id, formFields, listFunction, itemToDisplay) {
        let items = JSON.parse(localStorage.getItem(key) || '[]');
        const item = items[id];

        if (!item) {
            console.error('Item não encontrado para edição:', key, id);
            alert('Erro: Item não encontrado para edição.');
            return;
        }

        // Preenche os campos do formulário com os dados do item selecionado
        for (const field of formFields) {
            const inputElement = document.getElementById(field.id);
            if (inputElement) {
                if (field.type === 'date') {
                    // Para datas, garante que o formato seja 'YYYY-MM-DD'
                    inputElement.value = item[field.name] ? item[field.name].split('T')[0] : '';
                } else if (field.type === 'number') {
                    inputElement.value = item[field.name] !== undefined ? parseFloat(item[field.name]) : '';
                } else {
                    inputElement.value = item[field.name] || '';
                }
            }
        }

        if (confirm(`Você está prestes a editar este item:\n\n${itemToDisplay(item)}\n\nOs campos de cadastro acima foram preenchidos com os dados atuais. Por favor, faça suas alterações e CLIQUE EM "SALVAR" novamente para confirmar a edição. O item original será removido ao confirmar.`)) {
            // Remove o item original da lista, ele será recadastrado com as alterações
            items.splice(id, 1);
            localStorage.setItem(key, JSON.stringify(items));
            listFunction(); // Atualiza a lista para refletir a remoção (temporária) do item original
            alert('Item pronto para edição nos campos acima. Altere o que for necessário e clique em "Salvar" novamente para efetivar a mudança.');
        } else {
            // Se o usuário cancelar a edição, os campos podem ficar preenchidos, mas o item não é removido.
            // Poderíamos limpar os campos aqui, mas deixá-los preenchidos pode ser útil se o usuário mudar de ideia.
            // Para este cenário, o item original permanece inalterado na lista.
            alert('Edição cancelada. O item original não foi alterado.');
            // Opcional: Limpar os campos para evitar confusão se o usuário não for salvar
            // for (const field of formFields) {
            //     const inputElement = document.getElementById(field.id);
            //     if (inputElement) inputElement.value = '';
            // }
        }
    }

    /**
     * Função genérica para excluir um item.
     * @param {string} key - A chave do localStorage.
     * @param {number} id - O índice do item na lista.
     * @param {Function} listFunction - A função de listar/atualizar a UI para essa seção.
     * @param {Function} itemToDisplay - Uma função que recebe o item e retorna uma string para exibir no prompt de confirmação.
     */
    function excluirItem(key, id, listFunction, itemToDisplay) {
        let items = JSON.parse(localStorage.getItem(key) || '[]');
        const item = items[id];

        if (!item) {
            console.error('Item não encontrado para exclusão:', key, id);
            alert('Erro: Item não encontrado para exclusão.');
            return;
        }

        if (confirm(`Tem certeza que deseja excluir o seguinte item?\n\n${itemToDisplay(item)}`)) {
            items.splice(id, 1);
            localStorage.setItem(key, JSON.stringify(items));
            listFunction(); // Atualiza a UI

            // Se for pedido ou despesa, atualiza o financeiro
            if (key === 'pedidos' || key === 'despesas') {
                atualizarFinanceiro();
            }
            alert('Item excluído com sucesso!');
        }
    }

    // --- MÓDULO CLIENTES ---

    function salvarCliente() {
      const nomeInput = document.getElementById('clienteNome');
      const telefoneInput = document.getElementById('clienteTelefone');
      const enderecoInput = document.getElementById('clienteEndereco');

      const nome = nomeInput.value.trim();
      const telefone = telefoneInput.value.trim();
      const endereco = enderecoInput.value.trim();

      if (!nome || !telefone || !endereco) {
        return alert('Por favor, preencha todos os campos do cliente (Nome, Telefone, Endereço).');
      }

      // Validação de telefone simples (11 dígitos, apenas números)
      if (!/^\d{11}$/.test(telefone)) {
        return alert('Telefone inválido! Digite 11 dígitos, incluindo o DDD (ex: 51999998888).');
      }

      const clientes = JSON.parse(localStorage.getItem('clientes') || '[]');

      clientes.push({ nome, telefone, endereco });
      localStorage.setItem('clientes', JSON.stringify(clientes));

      nomeInput.value = '';
      telefoneInput.value = '';
      enderecoInput.value = '';

      listarClientes();
      alert('Cliente salvo com sucesso!');
    }

    function listarClientes() {
      const termoBusca = document.getElementById('buscaCliente').value.toLowerCase();
      const listaClientesUl = document.getElementById('listaClientes');
      listaClientesUl.innerHTML = ''; // Limpa a lista antes de preencher

      const clientes = JSON.parse(localStorage.getItem('clientes') || '[]');

      const clientesFiltrados = clientes.filter(c =>
          c.nome.toLowerCase().includes(termoBusca) ||
          c.telefone.toLowerCase().includes(termoBusca) ||
          c.endereco.toLowerCase().includes(termoBusca)
      );

      if (clientes.length === 0) {
        listaClientesUl.innerHTML = '<li class="empty-list-message">Nenhum cliente cadastrado ainda.</li>';
        return;
      }

      if (clientesFiltrados.length === 0 && termoBusca !== '') {
        listaClientesUl.innerHTML = `<li class="empty-list-message">Nenhum cliente encontrado com "${termoBusca}".</li>`;
        return;
      }

      clientesFiltrados.forEach((cliente, index) => {
        const li = document.createElement('li');
        const itemText = `<strong>${cliente.nome}</strong><br>Tel: ${cliente.telefone}<br>End: ${cliente.endereco}`;
        li.innerHTML = `
            <span class="item-details">${itemText}</span>
            <div class="item-actions">
                <button class="edit" onclick="editarItem('clientes', ${index}, [
                    {id:'clienteNome', name:'nome', type:'text'},
                    {id:'clienteTelefone', name:'telefone', type:'tel'},
                    {id:'clienteEndereco', name:'endereco', type:'text'}
                ], listarClientes, (item) => \`Nome: ${item.nome}, Tel: ${item.telefone}\`)">
                    <i class="fa-solid fa-pen"></i> Editar
                </button>
                <button class="delete" onclick="excluirItem('clientes', ${index}, listarClientes, (item) => \`Nome: ${item.nome}\`)">
                    <i class="fa-solid fa-trash"></i> Excluir
                </button>
            </div>
        `;
        listaClientesUl.appendChild(li);
      });
    }

    // --- MÓDULO PEDIDOS ---

    function salvarPedido() {
      const clienteInput = document.getElementById('pedidoCliente');
      const produtoInput = document.getElementById('tipoProduto');
      const valorInput = document.getElementById('valorPedido');
      const dataInput = document.getElementById('dataEntrega');
      const formaEntregaSelect = document.getElementById('formaEntrega');

      const nomeCliente = clienteInput.value.trim();
      const tipoProduto = produtoInput.value.trim();
      const valor = parseFloat(valorInput.value);
      const data = dataInput.value; // Formato YYYY-MM-DD
      const formaEntrega = formaEntregaSelect.value;

      if (!nomeCliente || !tipoProduto || isNaN(valor) || valor <= 0 || !data || !formaEntrega) {
        return alert('Por favor, preencha todos os campos do pedido corretamente (Valor deve ser positivo).');
      }

      const pedidos = JSON.parse(localStorage.getItem('pedidos') || '[]');
      pedidos.push({ nome: nomeCliente, produto: tipoProduto, valor, data, entrega: formaEntrega });
      localStorage.setItem('pedidos', JSON.stringify(pedidos));

      clienteInput.value = '';
      produtoInput.value = '';
      valorInput.value = '';
      dataInput.value = '';
      formaEntregaSelect.value = ''; // Limpa seleção

      listarPedidos();
      atualizarFinanceiro();
      alert('Pedido salvo com sucesso!');
    }

    function listarPedidos() {
      const listaPedidosUl = document.getElementById('listaPedidos');
      listaPedidosUl.innerHTML = '';
      const pedidos = JSON.parse(localStorage.getItem('pedidos') || '[]');

      if (pedidos.length === 0) {
        listaPedidosUl.innerHTML = '<li class="empty-list-message">Nenhum pedido cadastrado ainda.</li>';
        return;
      }

      pedidos.forEach((p, index) => {
        const li = document.createElement('li');
        // Formata a data para exibir como DD/MM/YYYY
        const dataFormatada = p.data ? new Date(p.data + 'T00:00:00').toLocaleDateString('pt-BR') : 'Data Indefinida';
        const itemText = `<strong>${p.nome}</strong> - ${p.produto}<br>Valor: R$ ${p.valor.toFixed(2)}<br>Entrega: ${p.entrega} em ${dataFormatada}`;
        li.innerHTML = `
            <span class="item-details">${itemText}</span>
            <div class="item-actions">
                <button class="edit" onclick="editarItem('pedidos', ${index}, [
                    {id:'pedidoCliente', name:'nome', type:'text'},
                    {id:'tipoProduto', name:'produto', type:'text'},
                    {id:'valorPedido', name:'valor', type:'number'},
                    {id:'dataEntrega', name:'data', type:'date'},
                    {id:'formaEntrega', name:'entrega', type:'select'}
                ], listarPedidos, (item) => \`Cliente: ${item.nome}, Produto: ${item.produto}, Valor: R$${item.valor.toFixed(2)}\`)">
                    <i class="fa-solid fa-pen"></i> Editar
                </button>
                <button class="delete" onclick="excluirItem('pedidos', ${index}, listarPedidos, (item) => \`Cliente: ${item.nome}, Produto: ${item.produto}\`)">
                    <i class="fa-solid fa-trash"></i> Excluir
                </button>
            </div>
        `;
        listaPedidosUl.appendChild(li);
      });
    }

    // --- MÓDULO DESPESAS ---

    let listaDespesasVisivel = false; // Estado para controlar a visibilidade da lista de despesas

    function salvarDespesa() {
      const categoriaSelect = document.getElementById('categoriaDespesa');
      const descricaoInput = document.getElementById('descricaoDespesa');
      const dataInput = document.getElementById('dataDespesa');
      const valorInput = document.getElementById('valorDespesa');

      const categoria = categoriaSelect.value;
      const descricao = descricaoInput.value.trim();
      const data = dataInput.value;
      const valor = parseFloat(valorInput.value);

      if (!categoria || !descricao || !data || isNaN(valor) || valor <= 0) {
        alert('Por favor, selecione uma categoria e preencha todos os campos da despesa corretamente (Descrição, Data, Valor positivo).');
        return;
      }

      let despesas = JSON.parse(localStorage.getItem('despesas') || '[]');
      despesas.push({ categoria, descricao, data, valor });
      localStorage.setItem('despesas', JSON.stringify(despesas));

      categoriaSelect.value = ''; // Limpa seleção
      descricaoInput.value = '';
      dataInput.value = '';
      valorInput.value = '';

      atualizarFinanceiro();
      // Garante que a lista de despesas esteja visível e atualizada após salvar
      listaDespesasVisivel = true;
      document.getElementById('listaDespesas').style.display = 'block';
      document.getElementById('btnVerDespesas').innerHTML = '<i class="fa-solid fa-eye-slash"></i> Ocultar Despesas';
      filtrarDespesas();
      alert('Despesa salva com sucesso!');
    }

    function filtrarDespesas() {
      let despesas = JSON.parse(localStorage.getItem('despesas') || '[]');
      const termoBusca = document.getElementById('buscaDescricaoDespesa').value.toLowerCase();
      const listaDespesasUl = document.getElementById('listaDespesas');
      listaDespesasUl.innerHTML = '';

      const despesasFiltradas = despesas.filter((d) =>
          d.descricao.toLowerCase().includes(termoBusca) ||
          d.categoria.toLowerCase().includes(termoBusca)
      );

      if (despesas.length === 0) {
          listaDespesasUl.innerHTML = '<li class="empty-list-message">Nenhuma despesa cadastrada ainda.</li>';
          return;
      }

      if (despesasFiltradas.length === 0 && termoBusca !== '') {
        listaDespesasUl.innerHTML = `<li class="empty-list-message">Nenhuma despesa encontrada com "${termoBusca}".</li>`;
        return;
      }

      despesasFiltradas.forEach((d, index) => {
        const li = document.createElement('li');
        const dataFormatada = d.data ? new Date(d.data + 'T00:00:00').toLocaleDateString('pt-BR') : 'Data Indefinida';
        const itemText = `<strong>${dataFormatada}</strong> | ${d.categoria} | ${d.descricao}<br>Valor: R$ ${d.valor.toFixed(2)}`;
        li.innerHTML = `
            <span class="item-details">${itemText}</span>
            <div class="item-actions">
                <button class="edit" onclick="editarItem('despesas', ${index}, [
                    {id:'categoriaDespesa', name:'categoria', type:'select'},
                    {id:'descricaoDespesa', name:'descricao', type:'text'},
                    {id:'dataDespesa', name:'data', type:'date'},
                    {id:'valorDespesa', name:'valor', type:'number'}
                ], filtrarDespesas, (item) => \`Descrição: ${item.descricao}, Valor: R$${item.valor.toFixed(2)}\`)">
                    <i class="fa-solid fa-pen"></i> Editar
                </button>
                <button class="delete" onclick="excluirItem('despesas', ${index}, filtrarDespesas, (item) => \`Descrição: ${item.descricao}\`)">
                    <i class="fa-solid fa-trash"></i> Excluir
                </button>
            </div>
        `;
        listaDespesasUl.appendChild(li);
      });
    }

    function toggleListaDespesas() {
      listaDespesasVisivel = !listaDespesasVisivel;
      const lista = document.getElementById('listaDespesas');
      const btn = document.getElementById('btnVerDespesas');

      if (listaDespesasVisivel) {
        lista.style.display = 'block';
        filtrarDespesas(); // Carrega as despesas ao mostrar
        btn.innerHTML = '<i class="fa-solid fa-eye-slash"></i> Ocultar Despesas';
      } else {
        lista.style.display = 'none';
        lista.innerHTML = ''; // Limpa a lista quando oculta
        btn.innerHTML = '<i class="fa-solid fa-eye"></i> Ver Todas as Despesas';
      }
    }

    // --- MÓDULO ESTOQUE ---

    function adicionarProduto() {
      const nomeInput = document.getElementById('produtoNome');
      const tipoSelect = document.getElementById('produtoTipo');
      const qtdInput = document.getElementById('produtoQtd');
      const minInput = document.getElementById('produtoMin');
      const validadeInput = document.getElementById('produtoValidade');

      const nome = nomeInput.value.trim();
      const tipo = tipoSelect.value;
      const qtd = parseInt(qtdInput.value);
      const min = parseInt(minInput.value);
      const validade = validadeInput.value;

      if (!nome || !tipo || isNaN(qtd) || qtd < 0 || isNaN(min) || min < 0) {
        return alert('Por favor, preencha todos os campos do produto corretamente (Quantidade e Mínimo devem ser números não negativos).');
      }

      const estoque = JSON.parse(localStorage.getItem('estoque') || '[]');
      const itemExistenteIndex = estoque.findIndex(p => p.nome.toLowerCase() === nome.toLowerCase() && p.tipo === tipo);

      if (itemExistenteIndex > -1) {
          // Se o item já existe, pergunta se quer adicionar à quantidade ou sobrescrever
          if (confirm(`O produto "${nome}" do tipo "${tipo}" já existe. Deseja ADICIONAR ${qtd} à quantidade existente ou ATUALIZAR (sobrescrever) o item? \n\nClique OK para ADICIONAR, ou CANCELAR para ATUALIZAR.`)) {
              estoque[itemExistenteIndex].qtd += qtd;
              // Atualiza validade e mínimo se fornecidos na adição
              if (validade) estoque[itemExistenteIndex].validade = validade;
              if (min) estoque[itemExistenteIndex].min = min;
              registrarHistorico(`+${qtd} ${nome} (${tipo}, adição de estoque)`);
              alert(`Adicionadas ${qtd} unidades de "${nome}" ao estoque.`);
          } else {
              // Atualiza o item existente com os novos valores completos
              estoque[itemExistenteIndex] = { nome, tipo, qtd, min, validade };
              registrarHistorico(`Atualizado: ${nome} (${tipo}, nova quantidade: ${qtd})`);
              alert(`Produto "${nome}" atualizado para ${qtd} unidades.`);
          }
      } else {
          // Adiciona novo item se não existir
          estoque.push({ nome, tipo, qtd, min, validade });
          registrarHistorico(`+${qtd} ${nome} (${tipo}, novo item no estoque)`);
          alert('Novo produto adicionado ao estoque!');
      }

      localStorage.setItem('estoque', JSON.stringify(estoque));

      nomeInput.value = '';
      tipoSelect.value = '';
      qtdInput.value = '';
      minInput.value = '';
      validadeInput.value = '';

      listarProdutos(); // Atualiza a lista
    }

    function listarProdutos() {
      const listaEstoqueUl = document.getElementById('listaEstoque');
      listaEstoqueUl.innerHTML = '';
      const termoBusca = document.getElementById('buscaProduto').value.toLowerCase();
      const tipoFiltro = document.getElementById('filtroTipoEstoque').value;
      const estoque = JSON.parse(localStorage.getItem('estoque') || '[]');

      const produtosFiltrados = estoque.filter(p => {
          const nomeMatch = p.nome.toLowerCase().includes(termoBusca);
          const tipoMatch = p.tipo.toLowerCase().includes(termoBusca); // Permite buscar por tipo também
          const filtroTipoMatch = tipoFiltro === '' || p.tipo === tipoFiltro;
          return (nomeMatch || tipoMatch) && filtroTipoMatch;
      });

      if (estoque.length === 0) {
        listaEstoqueUl.innerHTML = '<li class="empty-list-message">Nenhum produto em estoque.</li>';
        return;
      }

      if (produtosFiltrados.length === 0 && (termoBusca !== '' || tipoFiltro !== '')) {
        listaEstoqueUl.innerHTML = `<li class="empty-list-message">Nenhum produto encontrado com os filtros aplicados.</li>`;
        return;
      }

      produtosFiltrados.forEach((produto, index) => {
        const li = document.createElement('li');
        if (produto.qtd === 0) li.classList.add('falta');
        else if (produto.min > 0 && produto.qtd < produto.min) li.classList.add('baixo');

        const validadeInfo = produto.validade ? ` - Venc: ${new Date(produto.validade + 'T00:00:00').toLocaleDateString('pt-BR')}` : '';
        const itemText = `<strong>${produto.nome}</strong> (${produto.tipo}) - ${produto.qtd} un. (Mín: ${produto.min} un.)${validadeInfo}`;
        li.innerHTML = `
            <span class="item-details">${itemText}</span>
            <div class="item-actions">
                <button class="use" onclick="usarProduto(${index})">
                    <i class="fa-solid fa-minus"></i> Usar 1
                </button>
                <button class="edit" onclick="editarItem('estoque', ${index}, [
                    {id:'produtoNome', name:'nome', type:'text'},
                    {id:'produtoTipo', name:'tipo', type:'select'},
                    {id:'produtoQtd', name:'qtd', type:'number'},
                    {id:'produtoMin', name:'min', type:'number'},
                    {id:'produtoValidade', name:'validade', type:'date'}
                ], listarProdutos, (item) => \`Produto: ${item.nome} (${item.qtd} un., Tipo: ${item.tipo})\`)">
                    <i class="fa-solid fa-pen"></i> Editar
                </button>
                <button class="delete" onclick="excluirItem('estoque', ${index}, listarProdutos, (item) => \`Produto: ${item.nome} (${item.qtd} un.)\`)">
                    <i class="fa-solid fa-trash"></i> Excluir
                </button>
            </div>
        `;
        listaEstoqueUl.appendChild(li);
      });
    }

    function usarProduto(index) {
      const estoque = JSON.parse(localStorage.getItem('estoque') || '[]');
      if (estoque[index].qtd > 0) {
        if (confirm(`Deseja usar 1 unidade de "${estoque[index].nome}"?`)) {
            estoque[index].qtd--;
            localStorage.setItem('estoque', JSON.stringify(estoque));
            registrarHistorico(`-1 ${estoque[index].nome} (${estoque[index].tipo})`);
            listarProdutos(); // Atualiza a lista após o uso
            alert(`1 unidade de "${estoque[index].nome}" usada.`);
        }
      } else {
        alert(`Não há mais unidades de "${estoque[index].nome}" no estoque para usar.`);
      }
    }

    function registrarHistorico(texto) {
      const historico = JSON.parse(localStorage.getItem('historicoEstoque') || '[]');
      const dataHora = new Date().toLocaleString('pt-BR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
      historico.unshift(`${dataHora}: ${texto}`);
      localStorage.setItem('historicoEstoque', JSON.stringify(historico.slice(0, 30))); // Limita a 30 entradas
      listarHistorico();
    }

    function listarHistorico() {
      const listaHistoricoUl = document.getElementById('listaHistorico');
      listaHistoricoUl.innerHTML = '';
      const hist = JSON.parse(localStorage.getItem('historicoEstoque') || '[]');

      if (hist.length === 0) {
        listaHistoricoUl.innerHTML = '<li class="empty-list-message">Nenhum histórico de estoque ainda.</li>';
        return;
      }

      hist.forEach((entry) => {
        const li = document.createElement('li');
        li.textContent = entry;
        listaHistoricoUl.appendChild(li);
      });
    }

    // --- MÓDULO FINANCEIRO ---

    function preencherFiltrosAnoFinanceiro() {
        const selectAno = document.getElementById('filtroAnoFinanceiro');
        selectAno.innerHTML = '<option value="">Todos os Anos</option>'; // Resetar

        const currentYear = new Date().getFullYear();
        let allYears = new Set();

        // Coleta anos de pedidos
        const pedidos = JSON.parse(localStorage.getItem('pedidos') || '[]');
        pedidos.forEach(p => {
            if (p.data) allYears.add(new Date(p.data + 'T00:00:00').getFullYear());
        });

        // Coleta anos de despesas
        const despesas = JSON.parse(localStorage.getItem('despesas') || '[]');
        despesas.forEach(d => {
            if (d.data) allYears.add(new Date(d.data + 'T00:00:00').getFullYear());
        });

        const sortedYears = Array.from(allYears).sort((a, b) => a - b);

        // Garante que o ano atual e o próximo ano estejam disponíveis, mesmo que sem dados
        if (!sortedYears.includes(currentYear)) {
            sortedYears.push(currentYear);
        }
        if (!sortedYears.includes(currentYear + 1)) {
            sortedYears.push(currentYear + 1);
        }
        sortedYears.sort((a, b) => a - b); // Re-ordena após adicionar

        sortedYears.forEach(year => {
            const option = document.createElement('option');
            option.value = year.toString();
            option.textContent = year.toString();
            selectAno.appendChild(option);
        });
        selectAno.value = currentYear.toString(); // Seleciona o ano atual por padrão
    }

    function atualizarFinanceiro() {
      const pedidos = JSON.parse(localStorage.getItem('pedidos') || '[]');
      const despesas = JSON.parse(localStorage.getItem('despesas') || '[]');

      const filtroMes = document.getElementById('filtroMesFinanceiro').value;
      const filtroAno = document.getElementById('filtroAnoFinanceiro').value;

      const pedidosFiltrados = pedidos.filter(p => {
          if (!p.data) return false; // Ignora pedidos sem data
          const pedidoDate = new Date(p.data + 'T00:00:00'); // Garante fuso horário consistente
          const pedidoMonth = (pedidoDate.getMonth() + 1).toString().padStart(2, '0');
          const pedidoYear = pedidoDate.getFullYear().toString();
          return (filtroMes === '' || pedidoMonth === filtroMes) &&
                 (filtroAno === '' || pedidoYear === filtroAno);
      });

      const despesasFiltradas = despesas.filter(d => {
          if (!d.data) return false; // Ignora despesas sem data
          const despesaDate = new Date(d.data + 'T00:00:00'); // Garante fuso horário consistente
          const despesaMonth = (despesaDate.getMonth() + 1).toString().padStart(2, '0');
          const despesaYear = despesaDate.getFullYear().toString();
          return (filtroMes === '' || despesaMonth === filtroMes) &&
                 (filtroAno === '' || despesaYear === filtroAno);
      });

      const ganhos = pedidosFiltrados.reduce((s, p) => s + p.valor, 0);
      const gastos = despesasFiltradas.reduce((s, d) => s + d.valor, 0);
      const lucros = ganhos - gastos;

      document.getElementById('ganhos').textContent = ganhos.toFixed(2);
      document.getElementById('gastos').textContent = gastos.toFixed(2);
      document.getElementById('lucros').textContent = lucros.toFixed(2);

      // Atualiza listas de detalhes dos Ganhos
      const listaGanhos = document.getElementById('listaGanhosDetalhes');
      listaGanhos.innerHTML = '';
      if (pedidosFiltrados.length === 0) {
        listaGanhos.innerHTML = '<li class="empty-list-message">Nenhum ganho registrado para o período selecionado.</li>';
      } else {
        pedidosFiltrados.forEach(p => {
            const dataFormatada = p.data ? new Date(p.data + 'T00:00:00').toLocaleDateString('pt-BR') : 'Data Indefinida';
            const li = document.createElement('li');
            li.textContent = `${dataFormatada} - ${p.nome} (${p.produto}): R$ ${p.valor.toFixed(2)}`;
            listaGanhos.appendChild(li);
        });
      }

      // Atualiza listas de detalhes dos Gastos
      const listaGastos = document.getElementById('listaGastosDetalhes');
      listaGastos.innerHTML = '';
      if (despesasFiltradas.length === 0) {
        listaGastos.innerHTML = '<li class="empty-list-message">Nenhum gasto registrado para o período selecionado.</li>';
      } else {
        despesasFiltradas.forEach(d => {
            const dataFormatada = d.data ? new Date(d.data + 'T00:00:00').toLocaleDateString('pt-BR') : 'Data Indefinida';
            const li = document.createElement('li');
            li.textContent = `${dataFormatada} - ${d.categoria} (${d.descricao}): R$ ${d.valor.toFixed(2)}`;
            listaGastos.appendChild(li);
        });
      }
    }

    function toggleDetalhesFinanceiros(tipo) {
        const detalhesGanhosDiv = document.getElementById('detalhesGanhos');
        const detalhesGastosDiv = document.getElementById('detalhesGastos');

        // Fecha o outro painel se estiver aberto
        if (tipo === 'ganhos' && detalhesGastosDiv.classList.contains('active')) {
            detalhesGastosDiv.classList.remove('active');
        } else if (tipo === 'gastos' && detalhesGanhosDiv.classList.contains('active')) {
            detalhesGanhosDiv.classList.remove('active');
        }

        // Alterna o painel clicado
        if (tipo === 'ganhos') {
            detalhesGanhosDiv.classList.toggle('active');
        } else if (tipo === 'gastos') {
            detalhesGastosDiv.classList.toggle('active');
        }
    }

    // --- Funções de Carga Inicial ---
    // Esta função é chamada uma única vez ao entrar no app
    function atualizarTudo() {
      mostrar('clientes'); // Inicia na seção de Clientes por padrão
      listarClientes();
      listarPedidos();
      // Não chama filtrarDespesas() ou toggleListaDespesas() aqui para que a lista de despesas comece oculta
      // e só seja carregada se o usuário clicar em "Ver Despesas".
      atualizarFinanceiro();
      listarProdutos();
      listarHistorico();
    }
  </script>
</body>
</html>
