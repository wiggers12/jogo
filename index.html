<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doce Sabor Caseiro</title>
  <style>
    /* --- CSS Inserido Aqui --- */
    body {
      font-family: Arial, sans-serif;
      margin: 0; 
      padding: 0;
      background-color: #ffeef2; /* Rosa claro */
      color: #333;
      overflow-x: hidden; /* Evita scroll horizontal */
    }

    header {
      background: #e91e63; /* Rosa mais escuro */
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
    }

    nav {
      display: flex;
      justify-content: center;
      background: #fff;
      border-bottom: 2px solid #e91e63; /* Rosa mais escuro */
      flex-wrap: wrap;
      padding: 10px 0; /* Espaçamento para botões menores */
    }

    nav button {
      background: none;
      border: none;
      padding: 10px 15px; /* Padding ajustado */
      font-size: 15px; /* Tamanho da fonte ajustado */
      cursor: pointer;
      color: #e91e63; /* Rosa mais escuro */
      transition: background-color 0.3s ease, color 0.3s ease;
      white-space: nowrap; /* Evita quebra de linha nos botões */
    }

    nav button:hover, 
    nav button.active {
      background-color: #e91e63; /* Rosa mais escuro */
      color: white;
      border-radius: 5px 5px 0 0;
    }

    main {
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }

    section { 
      display: none; 
      animation: fadeIn 0.5s ease-in-out; /* Animação ao mostrar seção */
    }

    section.active { 
      display: block; 
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    input, select, textarea {
      font-size: 16px;
      padding: 10px; /* Padding um pouco maior */
      margin: 5px 0 15px 0;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ffb3c1; /* Rosa claro para bordas */
      border-radius: 4px;
    }

    .form-actions {
        display: flex;
        gap: 10px; /* Espaço entre os botões */
        justify-content: flex-start;
        margin-top: 15px;
    }

    button.primary {
      background-color: #e91e63; /* Rosa mais escuro */
      color: white;
      border: none;
      cursor: pointer;
      padding: 12px 20px; /* Padding horizontal maior */
      border-radius: 4px;
      font-weight: bold;
      width: auto;
      transition: background-color 0.3s ease;
    }

    button.primary:hover {
      background-color: #c2185b; /* Tom de rosa mais escuro no hover */
    }

    button.primary.cancel-button {
        background-color: #ccc; /* Cor cinza para cancelar */
        color: #333;
    }
    button.primary.cancel-button:hover {
        background-color: #a0a0a0;
    }


    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }

    th, td {
      border: 1px solid #ffb3c1; /* Rosa claro para bordas da tabela */
      padding: 10px;
      text-align: left;
    }

    th {
      background-color: #e91e63; /* Rosa mais escuro */
      color: white;
    }

    .table-wrapper { 
        overflow-x: auto; /* Permite scroll horizontal em tabelas grandes */
        border-radius: 8px; /* Bordas arredondadas na tabela */
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Sombra suave */
    }

    .action-buttons {
      display: flex;
      gap: 8px; /* Espaçamento entre os botões de ação */
    }

    .action-buttons button {
      width: auto;
      padding: 8px 12px;
      margin: 0;
      font-size: 14px;
      background-color: #f7a4b6; /* Rosa mais suave para botões de ação */
      color: #333;
      border: 1px solid #e91e63;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .action-buttons button:hover {
        background-color: #e91e63;
        color: white;
    }
    .action-buttons button.sold-button {
        background-color: #4CAF50; /* Verde para "Vendido" */
        color: white;
        border-color: #4CAF50;
    }
    .action-buttons button.sold-button:hover {
        background-color: #45a049;
    }


    /* Estilos para o Splash Screen */
    #splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #fce4ec; /* Rosa bem claro para o splash */
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 1000;
      opacity: 1;
      visibility: visible;
      transition: opacity 1s ease-out, visibility 1s ease-out;
    }
    #splash-screen.fade-out {
      opacity: 0;
      visibility: hidden;
    }
    #splash-screen h1 {
      color: #e91e63; /* Rosa mais escuro */
      font-size: 3em;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    #splash-screen .spinner {
      border: 6px solid #f3f3f3; /* Light grey */
      border-top: 6px solid #e91e63; /* Rosa mais escuro */
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .info-card {
        background-color: #fff;
        border: 1px solid #ffb3c1;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .info-card h3 {
        color: #e91e63;
        margin-top: 0;
        font-size: 1.2em;
    }
    .info-card p {
        font-size: 1.8em;
        font-weight: bold;
        color: #c2185b;
        margin: 5px 0;
    }
    .daily-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Ajustado para 250px */
        gap: 20px;
        margin-top: 20px;
    }

    /* Responsividade para telas menores */
    @media (max-width: 768px) {
        nav {
            flex-direction: column;
            align-items: center;
        }
        nav button {
            width: 90%;
            margin-bottom: 5px;
            border-radius: 4px;
        }
        main {
            padding: 10px;
        }
        .daily-summary {
            grid-template-columns: 1fr; /* Uma coluna em telas muito pequenas */
        }
        input, select, textarea {
            font-size: 14px;
        }
    }
  </style>
</head>
<body>

  <div id="splash-screen">
    <h1>Doce Sabor Caseiro</h1>
    <div class="spinner"></div>
  </div>

  <header>Doce Sabor Caseiro</header>
  <nav>
    <button id="btn-clientes" class="active">Clientes</button>
    <button id="btn-agenda">Agenda de Pedidos</button>
    <button id="btn-pedidos-vendidos">Pedidos Vendidos</button> <button id="btn-estoque">Estoque</button>
    <button id="btn-gastos">Gastos com Produtos</button>
    <button id="btn-financeiro">Financeiro</button>
    <button id="btn-vendas-diarias">Vendas do Período</button>
  </nav>
  <main>
    <section id="clientes" class="active">
      <h2>Cadastro de Clientes</h2>
      <form id="form-clientes">
        <label for="cliente-nome">Nome:</label>
        <input type="text" id="cliente-nome" required />
        <label for="cliente-telefone">Telefone:</label>
        <input type="tel" id="cliente-telefone" />
        <label for="cliente-observacoes">Observações:</label>
        <textarea id="cliente-observacoes"></textarea>
        <div class="form-actions">
            <button type="submit" class="primary" id="btn-submit-cliente">Salvar Cliente</button>
        </div>
      </form>
      <div class="table-wrapper">
        <table id="tabela-clientes">
            <thead>
                <tr><th>Nome</th><th>Telefone</th><th>Observações</th><th>Ações</th></tr>
            </thead>
            <tbody id="tabela-clientes-body"></tbody>
        </table>
      </div>
    </section>

    <section id="agenda">
      <h2>Agenda de Pedidos</h2>
      <form id="form-agenda">
        <label for="pedido-cliente">Cliente:</label>
        <input type="text" id="pedido-cliente" required />
        <label for="pedido-data">Data da Entrega:</label>
        <input type="date" id="pedido-data" required />
        <label for="pedido-tipo">Tipo de Bolo:</label>
        <input type="text" id="pedido-tipo" required />
        <label for="pedido-tamanho">Tamanho:</label>
        <select id="pedido-tamanho" required>
          <option value="">Selecione</option>
          <option>Pequeno</option>
          <option>Médio</option>
          <option>Grande</option>
        </select>
        <label for="pedido-valor">Valor (R$):</label>
        <input type="number" id="pedido-valor" step="0.01" required />
        <div class="form-actions">
            <button type="submit" class="primary" id="btn-submit-pedido">Adicionar Pedido</button>
        </div>
      </form>
      <div class="table-wrapper">
        <table id="tabela-agenda">
            <thead>
                <tr><th>Cliente</th><th>Data</th><th>Tipo</th><th>Tamanho</th><th>Valor</th><th>Ações</th></tr>
            </thead>
            <tbody id="tabela-agenda-body"></tbody>
        </table>
      </div>
    </section>

    <section id="pedidos-vendidos">
        <h2>Pedidos Vendidos</h2>
        <div class="table-wrapper">
            <table id="tabela-pedidos-vendidos">
                <thead>
                    <tr><th>Cliente</th><th>Data da Venda</th><th>Tipo</th><th>Tamanho</th><th>Valor</th><th>Ações</th></tr>
                </thead>
                <tbody id="tabela-pedidos-vendidos-body"></tbody>
            </table>
        </div>
    </section>
    <section id="estoque">
      <h2>Estoque de Ingredientes</h2>
      <form id="form-estoque">
        <label for="ingrediente-nome">Ingrediente:</label>
        <input type="text" id="ingrediente-nome" required />
        <label for="ingrediente-quantidade">Quantidade:</label>
        <input type="number" id="ingrediente-quantidade" required />
        <div class="form-actions">
            <button type="submit" class="primary" id="btn-submit-estoque">Adicionar Ingrediente</button>
        </div>
      </form>
      <div class="table-wrapper">
        <table id="tabela-estoque">
            <thead>
                <tr><th>Ingrediente</th><th>Quantidade</th><th>Ações</th></tr>
            </thead>
            <tbody id="tabela-estoque-body"></tbody>
        </table>
      </div>
    </section>

    <section id="gastos">
      <h2>Gastos com Produtos</h2>
      <form id="form-gastos">
        <label for="gasto-produto">Produto Comprado:</label>
        <input type="text" id="gasto-produto" required />
        <label for="gasto-quantidade">Quantidade:</label>
        <input type="number" id="gasto-quantidade" required />
        <label for="gasto-valor">Valor Total (R$):</label>
        <input type="number" id="gasto-valor" step="0.01" required />
        <div class="form-actions">
            <button type="submit" class="primary" id="btn-submit-gasto">Registrar Gasto</button>
        </div>
      </form>
      <div class="table-wrapper">
        <table id="tabela-gastos">
            <thead>
                <tr><th>Produto</th><th>Quantidade</th><th>Valor</th><th>Ações</th></tr>
            </thead>
            <tbody id="tabela-gastos-body"></tbody>
        </table>
      </div>
    </section>

    <section id="financeiro">
      <h2>Resumo Financeiro</h2>
      <p><strong>Total de Ganhos:</strong> R$ <span id="ganhos">0.00</span></p>
      <p><strong>Total de Gastos:</strong> R$ <span id="gastos">0.00</span></p>
      <p><strong>Lucro:</strong> R$ <span id="lucro">0.00</span></p>
    </section>

    <section id="vendas-diarias">
        <h2>Vendas do Período</h2>
        <div class="daily-summary">
            <div class="info-card">
                <h3>Vendas do Dia</h3>
                <p>R$ <span id="vendas-dia">0.00</span></p>
            </div>
            <div class="info-card">
                <h3>Vendas da Semana</h3>
                <p>R$ <span id="vendas-semana">0.00</span></p>
            </div>
            <div class-="info-card">
                <h3>Vendas do Mês</h3>
                <p>R$ <span id="vendas-mes">0.00</span></p>
            </div>
        </div>
    </section>
  </main>

  <script>
    /* --- JavaScript Inserido Aqui --- */

    // --- Elementos DOM ---
    const botoesNav = document.querySelectorAll("nav button");
    const secoes = document.querySelectorAll("main section");
    const splashScreen = document.getElementById("splash-screen");

    // --- Variáveis de Estado (para edição) ---
    let editingItemIndex = -1;
    let editingStorageKey = ''; // 'clientes', 'agenda', 'estoque', 'gastos'
    let currentActiveSectionId = 'clientes'; // Para saber qual seção está ativa e resetar o form

    // --- Mapeamentos para formulários (ID do campo no formulário) ---
    const formMappings = {
        clientes: {
            formId: 'form-clientes',
            tableBodyId: 'tabela-clientes-body',
            submitBtnId: 'btn-submit-cliente',
            formActionsId: 'cliente-form-actions', // Note: Adicionei esse ID ao div.form-actions no HTML para o cliente
            itemSingularName: 'cliente',
            inputMap: {
                nome: 'cliente-nome',
                telefone: 'cliente-telefone',
                observacoes: 'cliente-observacoes'
            }
        },
        agenda: {
            formId: 'form-agenda',
            tableBodyId: 'tabela-agenda-body',
            submitBtnId: 'btn-submit-pedido',
            formActionsId: 'pedido-form-actions', // Note: Adicionei esse ID ao div.form-actions no HTML para a agenda
            itemSingularName: 'pedido',
            inputMap: {
                cliente: 'pedido-cliente',
                data: 'pedido-data',
                tipo: 'pedido-tipo',
                tamanho: 'pedido-tamanho',
                valor: 'pedido-valor'
            },
            filter: (pedido) => !pedido.vendido, // Filtrar pedidos não vendidos
            sort: (a, b) => new Date(a.data) - new Date(b.data) // Ordenar por data
        },
        'pedidos-vendidos': {
            storageKey: 'pedidos-vendidos', // Nova chave de armazenamento
            tableBodyId: 'tabela-pedidos-vendidos-body',
            itemSingularName: 'pedido vendido',
            sort: (a, b) => new Date(b.dataVenda || b.data) - new Date(a.dataVenda || a.data) // Ordenar por data da venda (mais recente primeiro)
            // Não tem formulário de adição/edição direta, apenas visualização e exclusão
        },
        estoque: {
            formId: 'form-estoque',
            tableBodyId: 'tabela-estoque-body',
            submitBtnId: 'btn-submit-estoque',
            formActionsId: 'estoque-form-actions', // Note: Adicionei esse ID ao div.form-actions no HTML para o estoque
            itemSingularName: 'ingrediente',
            inputMap: {
                nome: 'ingrediente-nome',
                quantidade: 'ingrediente-quantidade'
            }
        },
        gastos: {
            formId: 'form-gastos',
            tableBodyId: 'tabela-gastos-body',
            submitBtnId: 'btn-submit-gasto',
            formActionsId: 'gasto-form-actions', // Note: Adicionei esse ID ao div.form-actions no HTML para gastos
            itemSingularName: 'gasto',
            inputMap: {
                produto: 'gasto-produto',
                quantidade: 'gasto-quantidade',
                valor: 'gasto-valor'
            }
        }
    };

    // --- Funções de Utilitários ---

    // Formata valor para moeda BRL
    const formatCurrency = (value) => {
        return parseFloat(value).toFixed(2).replace('.', ',');
    };

    // Obtém dados do LocalStorage
    const getLocalStorageData = (key) => {
        return JSON.parse(localStorage.getItem(key) || "[]");
    };

    // Salva dados no LocalStorage
    const setLocalStorageData = (key, data) => {
        localStorage.setItem(key, JSON.stringify(data));
    };

    // Formata a data para dd/mm/aaaa
    const formatDate = (dateString) => {
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}/${year}`;
    };

    // --- Funções de UI/UX ---

    // Exibe o splash screen e o esconde após um tempo
    const setupSplashScreen = () => {
        window.addEventListener("load", () => {
            setTimeout(() => {
                splashScreen.classList.add("fade-out");
                document.body.style.overflow = "auto";
            }, 2000);
        });
    };

    // Alterna a seção ativa
    const switchSection = (sectionId) => {
        // Reseta o formulário da seção que estava ativa, se houver
        const prevConfig = formMappings[currentActiveSectionId];
        if (prevConfig && prevConfig.formId) {
            resetForm(prevConfig);
        }

        botoesNav.forEach(b => b.classList.remove("active"));
        secoes.forEach(s => s.classList.remove("active"));
        
        const targetButton = document.getElementById(`btn-${sectionId}`);
        const targetSection = document.getElementById(sectionId);

        if (targetButton) targetButton.classList.add("active");
        if (targetSection) targetSection.classList.add("active");
        
        currentActiveSectionId = sectionId; // Atualiza a seção ativa

        // Carregar dados específicos da seção
        const config = formMappings[sectionId];
        if (config) {
            carregarDados({ 
                ...config, 
                storageKey: config.storageKey || sectionId, // Usa storageKey se definido, senão o próprio ID
                itemHtmlBuilder: (item, i) => {
                    if (sectionId === 'clientes') return clienteHtmlBuilder(item, i);
                    if (sectionId === 'agenda') return pedidoHtmlBuilder(item, i);
                    if (sectionId === 'pedidos-vendidos') return pedidoVendidoHtmlBuilder(item, i);
                    if (sectionId === 'estoque') return ingredienteHtmlBuilder(item, i);
                    if (sectionId === 'gastos') return gastoHtmlBuilder(item, i);
                    return '';
                }
            });
        }
        
        // Atualiza resumos ao trocar de seção
        atualizarFinanceiro();
        atualizarVendasPeriodo();
    };

    // --- Funções Genéricas de CRUD ---

    // Carrega dados e constrói a tabela (agora com filtro e ordenação opcionais)
    const carregarDados = (config) => {
        const { storageKey, tableBodyId, itemHtmlBuilder, filter, sort } = config;
        let dados = getLocalStorageData(storageKey);

        if (filter && typeof filter === 'function') {
            dados = dados.filter(filter);
        }
        if (sort && typeof sort === 'function') {
            dados.sort(sort);
        }

        const tableBody = document.getElementById(tableBodyId);

        if (tableBody) {
            tableBody.innerHTML = "";
            dados.forEach((item, i) => {
                tableBody.innerHTML += itemHtmlBuilder(item, i);
            });
        }
        // Só reseta o formulário se a seção tiver um formulário associado E não estiver em modo de edição
        if (config.formId && editingItemIndex === -1) {
             resetForm(config); 
        }
    };

    // Inicia o modo de edição
    const editarItem = (storageKey, index) => {
        const config = formMappings[storageKey];
        if (!config || !config.formId) { // Verifica se há um formulário para edição
            console.error('Configuração ou formulário não encontrado para edição:', storageKey);
            return;
        }

        // Se estiver editando um item da agenda, precisamos considerar o filtro
        let dataToEdit = getLocalStorageData(storageKey);
        if (storageKey === 'agenda' && config.filter) {
            const filteredData = dataToEdit.filter(config.filter);
            // O `index` passado aqui é o índice na lista FILTRADA, não no array original
            if (!filteredData[index]) {
                console.error("Item não encontrado na lista filtrada para edição.");
                return;
            }
            // Encontra o índice real no array original
            const originalData = getLocalStorageData(storageKey);
            index = originalData.findIndex(item => item === filteredData[index]);
            dataToEdit = originalData; // Usa o array original para edição
        }

        const item = dataToEdit[index];
        if (!item) {
            console.error("Item não encontrado no array para edição.");
            return;
        }

        const submitButton = document.getElementById(config.submitBtnId);
        const formActions = document.querySelector(`#${config.formId} .form-actions`);

        for (const key in config.inputMap) {
            const inputElement = document.getElementById(config.inputMap[key]);
            if (inputElement) {
                inputElement.value = item[key];
            }
        }
        
        let submitButtonText = `Atualizar ${config.itemSingularName.charAt(0).toUpperCase() + config.itemSingularName.slice(1)}`;
        if (config.itemSingularName === 'gasto') submitButtonText = "Atualizar Gasto"; 
        if (config.itemSingularName === 'cliente') submitButtonText = "Salvar Alterações"; 
        if (submitButton) {
            submitButton.textContent = submitButtonText;
            submitButton.classList.add("edit-mode");
        }
        
        const cancelButtonId = `btn-cancel-${config.formId.replace('form-', '')}`;
        if (formActions && !document.getElementById(cancelButtonId)) {
            const cancelButton = document.createElement("button");
            cancelButton.textContent = "Cancelar";
            cancelButton.type = "button";
            cancelButton.id = cancelButtonId;
            cancelButton.classList.add("primary", "cancel-button"); 
            cancelButton.onclick = () => resetForm(config);
            formActions.appendChild(cancelButton);
        }

        editingItemIndex = index; 
        editingStorageKey = storageKey;

        // Garante que a seção correta esteja visível para edição
        if (currentActiveSectionId !== storageKey) {
            switchSection(storageKey);
        }
    };

    // Reseta o formulário e sai do modo de edição
    const resetForm = (config) => {
        const formElement = document.getElementById(config.formId);
        if (formElement) formElement.reset();
        
        const submitButton = document.getElementById(config.submitBtnId);
        let buttonText = `Adicionar ${config.itemSingularName.charAt(0).toUpperCase() + config.itemSingularName.slice(1)}`;
        if (config.itemSingularName === 'gasto') buttonText = "Registrar Gasto"; 
        if (config.itemSingularName === 'cliente') buttonText = "Salvar Cliente"; 
        if (submitButton) {
            submitButton.textContent = buttonText;
            submitButton.classList.remove("edit-mode");
        }

        const cancelButton = document.getElementById(`btn-cancel-${config.formId.replace('form-', '')}`);
        if (cancelButton) {
            cancelButton.remove();
        }
        editingItemIndex = -1; 
        editingStorageKey = '';
    };

    // Exclui um item
    const excluirItem = (storageKey, index) => {
        if (!confirm("Tem certeza que deseja excluir este item? Esta ação é irreversível.")) {
            return; // Cancela se o usuário não confirmar
        }

        const config = formMappings[storageKey];
        if (!config) {
            console.error('Configuração não encontrada para:', storageKey);
            return;
        }
        let dados = getLocalStorageData(storageKey);
        
        // Ajusta o índice se a tabela estiver filtrada (agenda)
        let actualIndex = index; 
        if (storageKey === 'agenda' && config.filter) {
            const originalData = getLocalStorageData(storageKey);
            const filteredData = originalData.filter(config.filter);
            const itemToDelete = filteredData[index];
            actualIndex = originalData.findIndex(item => item === itemToDelete);
            dados = originalData; // Certifica que estamos modificando o array original
        }

        if (actualIndex === -1 || actualIndex >= dados.length) {
            console.error("Item não encontrado ou índice inválido para exclusão.");
            return;
        }

        dados.splice(actualIndex, 1);
        setLocalStorageData(storageKey, dados);
        
        // Recarrega a tabela específica
        // Chamar switchSection para garantir que a tabela seja recarregada com os filtros/ordenação corretos
        switchSection(storageKey); 
    };

    // --- Funções Específicas de Conteúdo e Lógica ---

    // Builders de HTML para as tabelas
    const clienteHtmlBuilder = (c, i) => `
        <tr>
            <td>${c.nome}</td>
            <td>${c.telefone}</td>
            <td>${c.observacoes}</td>
            <td>
                <div class="action-buttons">
                    <button onclick="editarItem('clientes', ${i})">Editar</button>
                    <button onclick="excluirItem('clientes', ${i})">Excluir</button>
                </div>
            </td>
        </tr>`;

    const pedidoHtmlBuilder = (a, i) => `
        <tr>
            <td>${a.cliente}</td>
            <td>${formatDate(a.data)}</td>
            <td>${a.tipo}</td>
            <td>${a.tamanho}</td>
            <td>R$ ${formatCurrency(a.valor)}</td>
            <td>
                <div class="action-buttons">
                    <button onclick="editarItem('agenda', ${i})">Editar</button>
                    <button class="sold-button" onclick="marcarPedidoComoVendido(${i})">Vendido</button>
                    <button onclick="excluirItem('agenda', ${i})">Excluir</button>
                </div>
            </td>
        </tr>`;
    
    // Novo builder para Pedidos Vendidos
    const pedidoVendidoHtmlBuilder = (a, i) => `
        <tr>
            <td>${a.cliente}</td>
            <td>${formatDate(a.dataVenda)}</td> <td>${a.tipo}</td>
            <td>${a.tamanho}</td>
            <td>R$ ${formatCurrency(a.valor)}</td>
            <td>
                <div class="action-buttons">
                    <button onclick="excluirItem('pedidos-vendidos', ${i})">Excluir</button>
                </div>
            </td>
        </tr>`;

    const ingredienteHtmlBuilder = (e, i) => `
        <tr>
            <td>${e.nome}</td>
            <td>${e.quantidade}</td>
            <td>
                <div class="action-buttons">
                    <button onclick="editarItem('estoque', ${i})">Editar</button>
                    <button onclick="excluirItem('estoque', ${i})">Excluir</button>
                </div>
            </td>
        </tr>`;

    const gastoHtmlBuilder = (g, i) => `
        <tr>
            <td>${g.produto}</td>
            <td>${g.quantidade}</td>
            <td>R$ ${formatCurrency(g.valor)}</td>
            <td>
                <div class="action-buttons">
                    <button onclick="editarItem('gastos', ${i})">Editar</button>
                    <button onclick="excluirItem('gastos', ${i})">Excluir</button>
                </div>
            </td>
        </tr>`;

    // --- Configuração dos Formulários ---
    const setupForm = (config) => {
        const formElement = document.getElementById(config.formId);
        if (!formElement) return;

        formElement.onsubmit = (e) => {
            e.preventDefault();
            
            let newItem = {};
            for (const key in config.inputMap) {
                const inputElement = document.getElementById(config.inputMap[key]);
                if (inputElement) {
                    newItem[key] = inputElement.value;
                }
            }
            
            // Validação básica para valores numéricos
            if (newItem.valor !== undefined && isNaN(parseFloat(newItem.valor))) {
                alert('Por favor, insira um valor numérico válido para o valor.');
                return;
            }
            if (newItem.quantidade !== undefined && isNaN(parseInt(newItem.quantidade))) {
                alert('Por favor, insira uma quantidade numérica válida.');
                return;
            }

            let data = getLocalStorageData(config.storageKey);

            if (editingItemIndex !== -1 && editingStorageKey === config.storageKey) {
                // Se estiver editando um pedido na agenda, mantenha o status 'vendido'
                if (config.storageKey === 'agenda') {
                    const originalAgenda = getLocalStorageData('agenda');
                    // O item sendo editado pode estar filtrado, então precisamos do índice real
                    const filteredAgenda = originalAgenda.filter(formMappings.agenda.filter);
                    const itemBeingEditedInFilteredList = filteredAgenda[editingItemIndex];
                    const realIndexInOriginalAgenda = originalAgenda.findIndex(item => item === itemBeingEditedInFilteredList);
                    
                    if (realIndexInOriginalAgenda !== -1) {
                         newItem.vendido = originalAgenda[realIndexInOriginalAgenda].vendido;
                    } else {
                         newItem.vendido = false; // Default para novos, mas isso não deve acontecer aqui
                    }
                    data = originalAgenda; // Trabalha com o array original
                    data[realIndexInOriginalAgenda] = newItem;

                } else {
                    data[editingItemIndex] = newItem;
                }
            } else {
                newItem.vendido = false; // Novos pedidos na agenda começam como não vendidos
                data.push(newItem);
            }
            setLocalStorageData(config.storageKey, data);
            
            // Recarrega a tabela relevante chamando switchSection para aplicar filtros/ordenação
            switchSection(config.storageKey); 
        };
    };

    // --- Nova Função: Marcar Pedido como Vendido ---
    const marcarPedidoComoVendido = (index) => {
        if (!confirm("Tem certeza que deseja marcar este pedido como VENDIDO?")) {
            return; // Cancela se o usuário não confirmar
        }

        let agenda = getLocalStorageData("agenda");
        let pedidosVendidos = getLocalStorageData("pedidos-vendidos");

        // Encontra o pedido real no array de agenda (sem filtro)
        // O `index` passado é o índice na lista FILTRADA
        const originalAgenda = getLocalStorageData('agenda');
        const filteredAgenda = originalAgenda.filter(formMappings.agenda.filter);
        const itemToMark = filteredAgenda[index];
        const originalIndex = originalAgenda.findIndex(item => item === itemToMark);

        if (originalIndex === -1 || !originalAgenda[originalIndex]) {
            console.error("Pedido não encontrado para marcar como vendido no array original.");
            return;
        }

        // Pega a data atual do sistema para a data da venda
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0'); // Meses são 0-indexed
        const dd = String(today.getDate()).padStart(2, '0');
        const dataAtualFormatada = `${yyyy}-${mm}-${dd}`;


        const pedidoVendido = { 
            ...originalAgenda[originalIndex], 
            vendido: true, 
            dataVenda: dataAtualFormatada // Data real da venda
        }; 
        
        pedidosVendidos.push(pedidoVendido);
        setLocalStorageData("pedidos-vendidos", pedidosVendidos);

        // Remove o pedido da agenda (array original)
        originalAgenda.splice(originalIndex, 1);
        setLocalStorageData("agenda", originalAgenda);

        // Recarrega ambas as tabelas
        switchSection('agenda'); // Recarrega a agenda
        // A seção 'pedidos-vendidos' será recarregada por switchSection, se for a ativa
        if (currentActiveSectionId === 'pedidos-vendidos') {
            switchSection('pedidos-vendidos');
        }

        alert(`Pedido do cliente ${pedidoVendido.cliente} marcado como vendido e movido para "Pedidos Vendidos"!`);
    };

    // --- Funções de Resumo ---

    const atualizarFinanceiro = () => {
        const pedidosVendidos = getLocalStorageData("pedidos-vendidos"); 
        const gastos = getLocalStorageData("gastos");

        const ganhos = pedidosVendidos.reduce((s, p) => s + parseFloat(p.valor || 0), 0);
        const despesas = gastos.reduce((s, g) => s + parseFloat(g.valor || 0), 0);
        const lucro = ganhos - despesas;

        document.getElementById("ganhos").textContent = formatCurrency(ganhos);
        document.getElementById("gastos").textContent = formatCurrency(despesas);
        document.getElementById("lucro").textContent = formatCurrency(lucro);
    };

    const atualizarVendasPeriodo = () => {
        const pedidosVendidos = getLocalStorageData("pedidos-vendidos"); 
        // Para usar a data real do sistema, use `new Date()`
        const hoje = new Date(); 
        hoje.setHours(0, 0, 0, 0); 

        // Vendas do Dia
        const vendasDia = pedidosVendidos.reduce((total, pedido) => {
            const dataVenda = new Date((pedido.dataVenda) + 'T00:00:00'); // Sempre usa dataVenda
            dataVenda.setHours(0, 0, 0, 0);
            if (dataVenda.getTime() === hoje.getTime()) {
                return total + parseFloat(pedido.valor || 0);
            }
            return total;
        }, 0);
        document.getElementById("vendas-dia").textContent = formatCurrency(vendasDia);

        // Vendas da Semana (Domingo a Sábado)
        const inicioSemana = new Date(hoje);
        inicioSemana.setDate(hoje.getDate() - hoje.getDay()); 
        inicioSemana.setHours(0, 0, 0, 0);

        const fimSemana = new Date(inicioSemana);
        fimSemana.setDate(inicioSemana.getDate() + 6); 
        fimSemana.setHours(23, 59, 59, 999);

        const vendasSemana = pedidosVendidos.reduce((total, pedido) => {
            const dataVenda = new Date((pedido.dataVenda) + 'T00:00:00');
            dataVenda.setHours(0, 0, 0, 0);
            if (dataVenda >= inicioSemana && dataVenda <= fimSemana) {
                return total + parseFloat(pedido.valor || 0);
            }
            return total;
        }, 0);
        document.getElementById("vendas-semana").textContent = formatCurrency(vendasSemana);

        // Vendas do Mês
        const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0); 
        fimMes.setHours(23, 59, 59, 999);

        const vendasMes = pedidosVendidos.reduce((total, pedido) => {
            const dataVenda = new Date((pedido.dataVenda) + 'T00:00:00');
            dataVenda.setHours(0, 0, 0, 0);
            if (dataVenda >= inicioMes && dataVenda <= fimMes) {
                return total + parseFloat(pedido.valor || 0);
            }
            return total;
        }, 0);
        document.getElementById("vendas-mes").textContent = formatCurrency(vendasMes);
    };

    // --- Inicialização ---
    document.addEventListener("DOMContentLoaded", () => {
        setupSplashScreen();

        // Adiciona o evento de click aos botões de navegação
        botoesNav.forEach(botao => {
            botao.addEventListener("click", () => switchSection(botao.id.replace("btn-", "")));
        });

        // Anexa as funções genéricas ao objeto window para acesso global (onclick em HTML)
        window.editarItem = editarItem;
        window.excluirItem = excluirItem;
        window.marcarPedidoComoVendido = marcarPedidoComoVendido; 

        // Adiciona os IDs para os form-actions no HTML, se ainda não existirem:
        // Ex: <div class="form-actions" id="cliente-form-actions">
        // Ex: <div class="form-actions" id="pedido-form-actions">
        // Ex: <div class="form-actions" id="estoque-form-actions">
        // Ex: <div class="form-actions" id="gasto-form-actions">

        // Configura os formulários
        setupForm({ ...formMappings.clientes, storageKey: 'clientes' });
        setupForm({ ...formMappings.agenda, storageKey: 'agenda' });
        setupForm({ ...formMappings.estoque, storageKey: 'estoque' });
        setupForm({ ...formMappings.gastos, storageKey: 'gastos' });

        // Carregamento inicial da primeira seção ativa
        switchSection(currentActiveSectionId); 
    });
  </script>
</body>
</html>
