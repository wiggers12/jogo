<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doce Sabor Caseiro</title>
  <style>
    /* Estilos globais e da splash screen */
    * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background: #fff0f5; margin: 0; color: #333; }
    .splash {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100vh; background: #f28ab2; color: white; text-align: center;
    }
    .splash h1 { font-size: 3rem; margin-bottom: 20px; }
    .splash button {
      background: white; color: #f28ab2; font-size: 1.2rem;
      border: none; padding: 12px 24px; border-radius: 8px;
      cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .container { display: none; padding: 20px; }

    /* Estilos da barra de navega√ß√£o */
    nav {
      display: flex; flex-wrap: wrap; justify-content: space-around;
      background: #f28ab2; padding: 12px 0; position: sticky; top: 0; z-index: 10;
    }
    nav button {
      background: none; border: none; color: white; font-size: 1rem;
      font-weight: bold; cursor: pointer; transition: transform 0.2s;
      display: flex; align-items: center; gap: 5px; /* Para alinhar texto e √≠cone */
    }
    nav button:hover { transform: scale(1.05); }

    /* Estilos das se√ß√µes */
    section {
      display: none; background: white; padding: 20px;
      margin-top: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      max-width: 600px; margin-left: auto; margin-right: auto;
    }
    section.active { display: block; }
    h2 {
      color: #f28ab2; margin-bottom: 16px;
      border-bottom: 2px solid #f28ab2; padding-bottom: 4px;
    }
    input, select {
      width: 100%; padding: 10px; margin-bottom: 12px;
      border: 1px solid #ccc; border-radius: 8px;
    }
    button.save {
      background: #f28ab2; color: white; padding: 10px 20px;
      border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
    }
    button.edit, button.delete {
        background: #ffc107; /* Amarelo para editar */
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 5px;
        font-size: 0.8em;
    }
    button.delete {
        background: #dc3545; /* Vermelho para excluir */
    }
    button.edit:hover, button.delete:hover {
        opacity: 0.9;
    }

    /* Estilos das listas de itens */
    ul { list-style: none; padding: 0; margin-top: 10px; max-height: 300px; overflow-y: auto; }
    li {
      background: #ffe6ec; margin-bottom: 8px; padding: 10px;
      border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      display: flex; justify-content: space-between; align-items: center; /* Para alinhar texto e bot√µes */
      flex-wrap: wrap; /* Permite quebrar linha em telas pequenas */
    }
    li .item-details {
        flex-grow: 1; /* Permite que os detalhes do item ocupem o espa√ßo dispon√≠vel */
    }
    li .item-actions {
        display: flex;
        gap: 5px;
        margin-top: 5px; /* Espa√ßamento caso quebre linha */
    }
    @media (min-width: 480px) {
        li .item-actions {
            margin-top: 0; /* Remove espa√ßamento se n√£o quebrar linha */
        }
    }

    /* Cores de status para estoque */
    .falta { background: #ffcdd2; } /* Vermelho claro */
    .baixo { background: #fff3cd; } /* Amarelo claro */
    .historico { font-size: 0.9rem; color: #555; }

    /* Estilos do Financeiro aprimorado */
    .financeiro-summary p {
        font-size: 1.1em;
        margin-bottom: 10px;
    }
    .financeiro-detail-toggle {
        background: #f28ab2;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 15px;
        margin-bottom: 10px;
    }
    .financeiro-list-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 10px;
        background: #fefefe;
        display: none; /* Inicia oculto */
    }
    .financeiro-list-container.active {
        display: block;
    }
    .financeiro-list-container h4 {
        color: #f28ab2;
        margin-top: 0;
        margin-bottom: 10px;
        border-bottom: 1px solid #f28ab2;
        padding-bottom: 5px;
    }
    .financeiro-list-container ul {
        max-height: none; /* Sobrescreve o max-height para este ul espec√≠fico */
        overflow-y: visible; /* Sobrescreve para este ul espec√≠fico */
        padding-left: 0;
    }
    .financeiro-list-container li {
        background: #fff0f5; /* Cor mais clara para itens de detalhe */
        font-size: 0.9em;
        padding: 8px;
        margin-bottom: 5px;
        border: 1px solid #ffe6ec;
    }
    .financeiro-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    .financeiro-filters select {
        flex: 1;
        min-width: 120px;
        margin-bottom: 0; /* Remove margin-bottom padr√£o */
    }
  </style>
</head>
<body>

  <div class="splash" id="splash">
    <h1>Doce Sabor Caseiro</h1>
    <button onclick="entrar()">Entrar</button>
  </div>

  <div class="container" id="app">
    <nav>
      <button onclick="mostrar('clientes')">üìã Clientes</button>
      <button onclick="mostrar('pedidos')">üßÅ Pedidos</button>
      <button onclick="mostrar('despesas')">üí∏ Despesas</button>
      <button onclick="mostrar('estoque')">üì¶ Estoque</button>
      <button onclick="mostrar('financeiro')">üí≤ Financeiro</button>
    </nav>

    <section id="clientes" class="active">
      <h2>Cadastro de Clientes</h2>
      <input id="clienteNome" placeholder="Nome do cliente" />
      <input id="clienteTelefone" placeholder="Telefone" />
      <input id="clienteEndereco" placeholder="Endere√ßo" />
      <button class="save" onclick="salvarCliente()">Salvar</button>
      <input id="buscaCliente" placeholder="Buscar cliente..." oninput="listarClientes()" />
      <ul id="listaClientes"></ul>
    </section>

    <section id="pedidos">
      <h2>Pedidos</h2>
      <input id="pedidoCliente" placeholder="Nome do cliente" />
      <input id="tipoProduto" placeholder="Tipo de produto" />
      <input id="valorPedido" type="number" placeholder="Valor (R$)" />
      <input id="dataEntrega" type="date" />
      <select id="formaEntrega">
        <option value="Entregar">Entregar</option>
        <option value="Retirar">Retirar</option>
      </select>
      <button class="save" onclick="salvarPedido()">Salvar Pedido</button>
      <ul id="listaPedidos"></ul>
    </section>

    <section id="despesas">
      <h2>Despesas</h2>

      <div style="background:#fff0f5; padding:16px; border-radius:12px; margin-bottom:16px; box-shadow:0 1px 4px rgba(0,0,0,0.1); max-width:500px;">
        <label style="display:block; margin-bottom:8px; font-weight:600; color:#b64d6d;">
          Categoria:
          <select id="categoriaDespesa" style="width:100%; padding:8px; margin-top:4px; border-radius:6px; border:1px solid #ccc;">
            <option>Mercadorias</option>
            <option>Loja</option>
            <option>Pessoais</option>
          </select>
        </label>

        <label style="display:block; margin-bottom:8px; font-weight:600; color:#b64d6d;">
          Descri√ß√£o da despesa:
          <input type="text" id="descricaoDespesa" placeholder="Descri√ß√£o..." style="width:100%; padding:8px; margin-top:4px; border-radius:6px; border:1px solid #ccc;" />
        </label>

        <label style="display:block; margin-bottom:8px; font-weight:600; color:#b64d6d;">
          Data da despesa:
          <input type="date" id="dataDespesa" style="width:100%; padding:8px; margin-top:4px; border-radius:6px; border:1px solid #ccc;" />
        </label>

        <label style="display:block; margin-bottom:12px; font-weight:600; color:#b64d6d;">
          Valor (R$):
          <input type="number" step="0.01" min="0" id="valorDespesa" placeholder="0,00" style="width:100%; padding:8px; margin-top:4px; border-radius:6px; border:1px solid #ccc;" />
        </label>

        <button
          class="save"
          onclick="salvarDespesa()"
          style="background:#f28ab2; color:#fff; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;"
        >
          Salvar
        </button>
      </div>

      <div style="max-width:500px; margin-bottom:16px;">
        <label for="buscaDescricaoDespesa" style="font-weight:600; color:#b64d6d;">Buscar despesas pelo nome:</label>
        <div style="display:flex; gap:8px; margin-top:6px;">
          <input
            type="text"
            id="buscaDescricaoDespesa"
            placeholder="Digite descri√ß√£o para buscar..."
            style="flex:1; padding:8px; border-radius:6px; border:1px solid #ccc;"
            onkeydown="if(event.key==='Enter'){filtrarDespesas()}"
          />
          <button
            onclick="filtrarDespesas()"
            style="background:#f28ab2; color:#fff; border:none; border-radius:6px; padding:0 16px; cursor:pointer; font-weight:bold;"
          >
            Buscar
          </button>
        </div>
      </div>

      <button
        id="btnVerDespesas"
        onclick="toggleListaDespesas()"
        style="background:#b64d6d; color:#fff; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; margin-bottom:12px; max-width:500px;"
      >
        Ver despesas
      </button>

      <ul
        id="listaDespesas"
        style="max-width:500px; max-height:300px; overflow-y:auto; margin-top:12px; padding-left:0; list-style:none; display:none;"
      ></ul>
    </section>

    <section id="estoque">
      <h2>Controle de Estoque</h2>
      <input id="produtoNome" placeholder="Nome do Produto" />
      <select id="produtoTipo">
        <option value="Ingrediente">Ingrediente</option>
        <option value="Embalagem">Embalagem</option>
        <option value="Produto Final">Produto Final</option>
      </select>
      <input id="produtoQtd" type="number" placeholder="Quantidade" />
      <input id="produtoMin" type="number" placeholder="M√≠nimo Ideal" />
      <input id="produtoValidade" type="date" placeholder="Validade" />
      <button onclick="adicionarProduto()">Adicionar Produto</button>
      <input id="buscaProduto" placeholder="Buscar produto..." oninput="listarProdutos()" />
      <select id="filtroTipo" onchange="listarProdutos()">
        <option value="">Todos</option>
        <option value="Ingrediente">Ingrediente</option>
        <option value="Embalagem">Embalagem</option>
        <option value="Produto Final">Produto Final</option>
      </select>
      <ul id="listaEstoque"></ul>
      <h3>Hist√≥rico</h3>
      <ul id="listaHistorico" class="historico"></ul>
    </section>

    <section id="financeiro">
      <h2>Financeiro</h2>
      <div class="financeiro-filters">
        <select id="filtroMesFinanceiro" onchange="atualizarFinanceiro()">
          <option value="">Todos os Meses</option>
          <option value="01">Janeiro</option><option value="02">Fevereiro</option>
          <option value="03">Mar√ßo</option><option value="04">Abril</option>
          <option value="05">Maio</option><option value="06">Junho</option>
          <option value="07">Julho</option><option value="08">Agosto</option>
          <option value="09">Setembro</option><option value="10">Outubro</option>
          <option value="11">Novembro</option><option value="12">Dezembro</option>
        </select>
        <select id="filtroAnoFinanceiro" onchange="atualizarFinanceiro()">
          <option value="">Todos os Anos</option>
          </select>
      </div>

      <div class="financeiro-summary">
        <p>
          <strong>Ganhos:</strong> R$ <span id="ganhos">0.00</span>
        </p>
        <p>
          <strong>Gastos:</strong> R$ <span id="gastos">0.00</span>
        </p>
        <p>
          <strong>Lucros:</strong> R$ <span id="lucros">0.00</span>
        </p>
      </div>

      <button class="financeiro-detail-toggle" onclick="toggleDetalhesFinanceiros('ganhos')">
        Detalhes dos Ganhos
      </button>
      <div id="detalhesGanhos" class="financeiro-list-container">
        <h4>Ganhos por Pedido</h4>
        <ul id="listaGanhosDetalhes"></ul>
      </div>

      <button class="financeiro-detail-toggle" onclick="toggleDetalhesFinanceiros('gastos')">
        Detalhes dos Gastos
      </button>
      <div id="detalhesGastos" class="financeiro-list-container">
        <h4>Gastos por Despesa</h4>
        <ul id="listaGastosDetalhes"></ul>
      </div>
    </section>
  </div>

  <script>
    function entrar() {
      document.getElementById('splash').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      preencherFiltrosAnoFinanceiro(); // Adicionado para preencher os anos dispon√≠veis
      atualizarTudo();
    }

    function mostrar(secao) {
      document.querySelectorAll('section').forEach((s) => s.classList.remove('active'));
      document.getElementById(secao).classList.add('active');
    }

    // Fun√ß√µes gen√©ricas de Edi√ß√£o e Exclus√£o
    // Par√¢metros:
    //  - key: chave do localStorage (ex: 'clientes', 'pedidos')
    //  - id: √≠ndice do item na lista
    //  - formFields: array de IDs dos campos de formul√°rio para preencher na edi√ß√£o
    //  - listFunction: fun√ß√£o que lista os itens (para atualizar a UI)
    //  - itemToDisplay: fun√ß√£o que retorna a string de exibi√ß√£o do item para o prompt de confirma√ß√£o
    function editarItem(key, id, formFields, listFunction, itemToDisplay) {
        let items = JSON.parse(localStorage.getItem(key) || '[]');
        const item = items[id];

        if (!item) return;

        // Preenche os campos do formul√°rio
        for (const field of formFields) {
            const inputElement = document.getElementById(field.id);
            if (inputElement) {
                // Lida com tipos de campo espec√≠ficos (ex: 'date', 'number')
                if (field.type === 'date') {
                    inputElement.value = item[field.name]; // Assume que o nome do campo corresponde √† chave no objeto
                } else if (field.type === 'number') {
                     inputElement.value = parseFloat(item[field.name]);
                }
                else {
                    inputElement.value = item[field.name];
                }
            }
        }

        // Remove o item original para que uma nova vers√£o editada possa ser salva
        if (confirm(`Deseja editar este item? O item original ser√° removido ao salvar: ${itemToDisplay(item)}`)) {
            items.splice(id, 1);
            localStorage.setItem(key, JSON.stringify(items));
            alert('Item pronto para edi√ß√£o nos campos acima. Lembre-se de salvar novamente!');
            listFunction(); // Atualiza a lista para remover o item "editado" temporariamente
        }
    }

    function excluirItem(key, id, listFunction, itemToDisplay) {
        let items = JSON.parse(localStorage.getItem(key) || '[]');
        const item = items[id];

        if (!item) return;

        if (confirm(`Tem certeza que deseja excluir: ${itemToDisplay(item)}?`)) {
            items.splice(id, 1);
            localStorage.setItem(key, JSON.stringify(items));
            listFunction();
            // Se for pedido ou despesa, atualizar o financeiro
            if (key === 'pedidos' || key === 'despesas') {
                atualizarFinanceiro();
            }
            alert('Item exclu√≠do com sucesso!');
        }
    }

    // CLIENTES
    function salvarCliente() {
      const nome = clienteNome.value.trim();
      const telefone = clienteTelefone.value.trim();
      const endereco = clienteEndereco.value.trim();
      if (!nome || !telefone || !endereco) return alert('Preencha todos os campos');
      const clientes = JSON.parse(localStorage.getItem('clientes') || '[]');
      clientes.push({ nome, telefone, endereco });
      localStorage.setItem('clientes', JSON.stringify(clientes));
      clienteNome.value = clienteTelefone.value = clienteEndereco.value = '';
      listarClientes();
      alert('Cliente salvo com sucesso!');
    }
    function listarClientes() {
      const termo = document.getElementById('buscaCliente').value.toLowerCase();
      const lista = document.getElementById('listaClientes');
      lista.innerHTML = '';
      const clientes = JSON.parse(localStorage.getItem('clientes') || '[]');
      clientes.forEach((c, index) => {
        if (!c.nome.toLowerCase().includes(termo)) return;
        const li = document.createElement('li');
        const itemText = `${c.nome} - ${c.telefone} (${c.endereco})`;
        li.innerHTML = `
            <span class="item-details">${itemText}</span>
            <div class="item-actions">
                <button class="edit" onclick="editarItem('clientes', ${index}, [{id:'clienteNome', name:'nome'}, {id:'clienteTelefone', name:'telefone'}, {id:'clienteEndereco', name:'endereco'}], listarClientes, (item) => \`${item.nome}\`)">Editar</button>
                <button class="delete" onclick="excluirItem('clientes', ${index}, listarClientes, (item) => \`${item.nome}\`)">Excluir</button>
            </div>
        `;
        lista.appendChild(li);
      });
    }

    // PEDIDOS
    function salvarPedido() {
      const nome = pedidoCliente.value.trim();
      const produto = tipoProduto.value.trim();
      const valor = parseFloat(valorPedido.value);
      const entrega = formaEntrega.value;
      const data = dataEntrega.value;
      if (!nome || !produto || isNaN(valor) || valor <= 0 || !data) return alert('Preencha todos os campos e o valor deve ser positivo.');
      const pedidos = JSON.parse(localStorage.getItem('pedidos') || '[]');
      pedidos.push({ nome, produto, valor, entrega, data });
      localStorage.setItem('pedidos', JSON.stringify(pedidos));
      pedidoCliente.value = tipoProduto.value = valorPedido.value = dataEntrega.value = '';
      listarPedidos();
      atualizarFinanceiro();
      alert('Pedido salvo com sucesso!');
    }
    function listarPedidos() {
      const lista = document.getElementById('listaPedidos');
      lista.innerHTML = '';
      const pedidos = JSON.parse(localStorage.getItem('pedidos') || '[]');
      pedidos.forEach((p, index) => {
        const li = document.createElement('li');
        const itemText = `${p.nome} - ${p.produto} - R$${p.valor.toFixed(2)} - ${p.entrega} (${p.data})`;
        li.innerHTML = `
            <span class="item-details">${itemText}</span>
            <div class="item-actions">
                <button class="edit" onclick="editarItem('pedidos', ${index}, [
                    {id:'pedidoCliente', name:'nome'},
                    {id:'tipoProduto', name:'produto'},
                    {id:'valorPedido', name:'valor', type:'number'},
                    {id:'dataEntrega', name:'data', type:'date'},
                    {id:'formaEntrega', name:'entrega'}
                ], listarPedidos, (item) => \`Pedido de ${item.nome} (${item.produto})\`)">Editar</button>
                <button class="delete" onclick="excluirItem('pedidos', ${index}, listarPedidos, (item) => \`Pedido de ${item.nome} (${item.produto})\`)">Excluir</button>
            </div>
        `;
        lista.appendChild(li);
      });
    }

    // DESPESAS
    let listaDespesasVisivel = false;

    function salvarDespesa() {
      const categoria = document.getElementById('categoriaDespesa').value;
      const descricao = document.getElementById('descricaoDespesa').value.trim();
      const data = document.getElementById('dataDespesa').value;
      const valor = parseFloat(document.getElementById('valorDespesa').value);

      if (!descricao || !data || isNaN(valor) || valor <= 0) {
        alert('Preencha todos os campos corretamente e o valor deve ser positivo!');
        return;
      }

      let despesas = JSON.parse(localStorage.getItem('despesas') || '[]');
      despesas.push({ categoria, descricao, data, valor });
      localStorage.setItem('despesas', JSON.stringify(despesas));

      document.getElementById('descricaoDespesa').value = '';
      document.getElementById('dataDespesa').value = '';
      document.getElementById('valorDespesa').value = '';

      atualizarFinanceiro();
      listaDespesasVisivel = true;
      document.getElementById('listaDespesas').style.display = 'block';
      document.getElementById('btnVerDespesas').textContent = 'Ocultar despesas';
      filtrarDespesas();
      alert('Despesa salva com sucesso!');
    }

    function filtrarDespesas() {
      let despesas = JSON.parse(localStorage.getItem('despesas') || '[]');
      const termo = document.getElementById('buscaDescricaoDespesa').value.toLowerCase();
      const lista = document.getElementById('listaDespesas');
      lista.innerHTML = '';

      const filtradas = despesas.filter((d) => d.descricao.toLowerCase().includes(termo));

      if (filtradas.length === 0) {
        lista.innerHTML = '<li style="color:#999; font-style:italic;">Nenhuma despesa encontrada.</li>';
        return;
      }

      filtradas.forEach((d, index) => {
        const li = document.createElement('li');
        li.style.background = '#ffe6ec';
        li.style.marginBottom = '8px';
        li.style.padding = '10px';
        li.style.borderRadius = '6px';
        const itemText = `${d.data} | ${d.categoria} | ${d.descricao} - R$ ${d.valor.toFixed(2)}`;
        li.innerHTML = `
            <span class="item-details">${itemText}</span>
            <div class="item-actions">
                <button class="edit" onclick="editarItem('despesas', ${index}, [
                    {id:'categoriaDespesa', name:'categoria'},
                    {id:'descricaoDespesa', name:'descricao'},
                    {id:'dataDespesa', name:'data', type:'date'},
                    {id:'valorDespesa', name:'valor', type:'number'}
                ], filtrarDespesas, (item) => \`Despesa: ${item.descricao} (R$${item.valor.toFixed(2)})\`)">Editar</button>
                <button class="delete" onclick="excluirItem('despesas', ${index}, filtrarDespesas, (item) => \`Despesa: ${item.descricao} (R$${item.valor.toFixed(2)})\`)">Excluir</button>
            </div>
        `;
        lista.appendChild(li);
      });
    }

    function toggleListaDespesas() {
      listaDespesasVisivel = !listaDespesasVisivel;
      const lista = document.getElementById('listaDespesas');
      lista.style.display = listaDespesasVisivel ? 'block' : 'none';

      if (listaDespesasVisivel) {
        filtrarDespesas();
      } else {
        lista.innerHTML = '';
      }

      const btn = document.getElementById('btnVerDespesas');
      btn.textContent = listaDespesasVisivel ? 'Ocultar despesas' : 'Ver despesas';
    }

    // ESTOQUE
    function adicionarProduto() {
      const nome = produtoNome.value.trim();
      const tipo = produtoTipo.value;
      const qtd = parseInt(produtoQtd.value);
      const min = parseInt(produtoMin.value);
      const validade = produtoValidade.value;
      if (!nome || isNaN(qtd) || qtd < 0 || isNaN(min) || min < 0) return alert('Preencha nome, quantidade e m√≠nimo ideal corretamente (valores n√£o negativos).');

      const estoque = JSON.parse(localStorage.getItem('estoque') || '[]');
      const itemExistenteIndex = estoque.findIndex(p => p.nome.toLowerCase() === nome.toLowerCase() && p.tipo === tipo);

      if (itemExistenteIndex > -1) {
          // Se o item j√° existe, pergunta se quer atualizar a quantidade ou criar um novo
          if (confirm(`O produto "${nome}" do tipo "${tipo}" j√° existe. Deseja adicionar ${qtd} √† quantidade existente ou editar?`)) {
              estoque[itemExistenteIndex].qtd += qtd;
              if (validade) estoque[itemExistenteIndex].validade = validade; // Atualiza validade se fornecida
              if (min) estoque[itemExistenteIndex].min = min; // Atualiza min se fornecido
              registrarHistorico(`+${qtd} ${nome} (atualiza√ß√£o)`);
          } else {
              // Se n√£o quiser adicionar, apenas limpa os campos
              produtoNome.value = produtoQtd.value = produtoMin.value = produtoValidade.value = '';
              return;
          }
      } else {
          // Adiciona novo item se n√£o existir
          estoque.push({ nome, tipo, qtd, min: isNaN(min) ? 0 : min, validade });
          registrarHistorico(`+${qtd} ${nome} (novo)`);
      }

      localStorage.setItem('estoque', JSON.stringify(estoque));
      produtoNome.value = produtoQtd.value = produtoMin.value = produtoValidade.value = '';
      listarProdutos();
      alert('Produto salvo/atualizado com sucesso!');
    }

    function listarProdutos() {
      const lista = document.getElementById('listaEstoque');
      lista.innerHTML = '';
      const filtro = buscaProduto.value.toLowerCase();
      const tipoFiltro = filtroTipo.value;
      const estoque = JSON.parse(localStorage.getItem('estoque') || '[]');
      estoque.forEach((p, index) => {
        if (filtro && !p.nome.toLowerCase().includes(filtro)) return;
        if (tipoFiltro && p.tipo !== tipoFiltro) return;
        const li = document.createElement('li');
        if (p.qtd === 0) li.classList.add('falta');
        else if (p.min > 0 && p.qtd < p.min) li.classList.add('baixo');
        const itemText = `<strong>${p.nome}</strong> (${p.tipo}) - ${p.qtd} un. ${
          p.validade ? ' - Venc: ' + p.validade : ''
        }`;
        li.innerHTML = `
            <span class="item-details">${itemText}</span>
            <div class="item-actions">
                <button onclick="usarProduto(${index})">Usar</button>
                <button class="edit" onclick="editarItem('estoque', ${index}, [
                    {id:'produtoNome', name:'nome'},
                    {id:'produtoTipo', name:'tipo'},
                    {id:'produtoQtd', name:'qtd', type:'number'},
                    {id:'produtoMin', name:'min', type:'number'},
                    {id:'produtoValidade', name:'validade', type:'date'}
                ], listarProdutos, (item) => \`Produto: ${item.nome} (${item.qtd} un.)\`)">Editar</button>
                <button class="delete" onclick="excluirItem('estoque', ${index}, listarProdutos, (item) => \`Produto: ${item.nome} (${item.qtd} un.)\`)">Excluir</button>
            </div>
        `;
        lista.appendChild(li);
      });
    }
    function usarProduto(index) {
      const estoque = JSON.parse(localStorage.getItem('estoque') || '[]');
      if (estoque[index].qtd > 0) {
        estoque[index].qtd--;
        localStorage.setItem('estoque', JSON.stringify(estoque));
        registrarHistorico(`-1 ${estoque[index].nome}`);
        listarProdutos();
        alert(`1 unidade de "${estoque[index].nome}" usada.`);
      } else {
        alert(`N√£o h√° mais unidades de "${estoque[index].nome}" no estoque.`);
      }
    }
    function registrarHistorico(texto) {
      const historico = JSON.parse(localStorage.getItem('historicoEstoque') || '[]');
      const data = new Date().toLocaleString();
      historico.unshift(`${data}: ${texto}`);
      localStorage.setItem('historicoEstoque', JSON.stringify(historico.slice(0, 20)));
      listarHistorico();
    }
    function listarHistorico() {
      const lista = document.getElementById('listaHistorico');
      lista.innerHTML = '';
      const hist = JSON.parse(localStorage.getItem('historicoEstoque') || '[]');
      hist.forEach((entry) => {
        const li = document.createElement('li');
        li.textContent = entry;
        lista.appendChild(li);
      });
    }

    // FINANCEIRO APRIMORADO
    function preencherFiltrosAnoFinanceiro() {
        const selectAno = document.getElementById('filtroAnoFinanceiro');
        selectAno.innerHTML = '<option value="">Todos os Anos</option>'; // Resetar
        const currentYear = new Date().getFullYear();
        for (let i = currentYear - 5; i <= currentYear + 1; i++) { // √öltimos 5 anos, ano atual e pr√≥ximo
            const option = document.createElement('option');
            option.value = i.toString();
            option.textContent = i.toString();
            selectAno.appendChild(option);
        }
    }

    function atualizarFinanceiro() {
      const pedidos = JSON.parse(localStorage.getItem('pedidos') || '[]');
      const despesas = JSON.parse(localStorage.getItem('despesas') || '[]');

      const filtroMes = document.getElementById('filtroMesFinanceiro').value;
      const filtroAno = document.getElementById('filtroAnoFinanceiro').value;

      const pedidosFiltrados = pedidos.filter(p => {
          const pedidoDate = new Date(p.data + 'T00:00:00'); // Garante fuso hor√°rio para compara√ß√£o correta
          const pedidoMonth = (pedidoDate.getMonth() + 1).toString().padStart(2, '0');
          const pedidoYear = pedidoDate.getFullYear().toString();
          return (filtroMes === '' || pedidoMonth === filtroMes) &&
                 (filtroAno === '' || pedidoYear === filtroAno);
      });

      const despesasFiltradas = despesas.filter(d => {
          const despesaDate = new Date(d.data + 'T00:00:00');
          const despesaMonth = (despesaDate.getMonth() + 1).toString().padStart(2, '0');
          const despesaYear = despesaDate.getFullYear().toString();
          return (filtroMes === '' || despesaMonth === filtroMes) &&
                 (filtroAno === '' || despesaYear === filtroAno);
      });

      const ganhos = pedidosFiltrados.reduce((s, p) => s + p.valor, 0);
      const gastos = despesasFiltradas.reduce((s, d) => s + d.valor, 0);
      const lucros = ganhos - gastos;

      document.getElementById('ganhos').textContent = ganhos.toFixed(2);
      document.getElementById('gastos').textContent = gastos.toFixed(2);
      document.getElementById('lucros').textContent = lucros.toFixed(2);

      // Atualiza listas de detalhes
      const listaGanhos = document.getElementById('listaGanhosDetalhes');
      listaGanhos.innerHTML = '';
      pedidosFiltrados.forEach(p => {
          const li = document.createElement('li');
          li.textContent = `${p.data} - ${p.nome} (${p.produto}): R$ ${p.valor.toFixed(2)}`;
          listaGanhos.appendChild(li);
      });

      const listaGastos = document.getElementById('listaGastosDetalhes');
      listaGastos.innerHTML = '';
      despesasFiltradas.forEach(d => {
          const li = document.createElement('li');
          li.textContent = `${d.data} - ${d.categoria} (${d.descricao}): R$ ${d.valor.toFixed(2)}`;
          listaGastos.appendChild(li);
      });
    }

    function toggleDetalhesFinanceiros(tipo) {
        const detalhesGanhosDiv = document.getElementById('detalhesGanhos');
        const detalhesGastosDiv = document.getElementById('detalhesGastos');

        if (tipo === 'ganhos') {
            detalhesGanhosDiv.classList.toggle('active');
            detalhesGastosDiv.classList.remove('active'); // Garante que apenas um esteja aberto
        } else if (tipo === 'gastos') {
            detalhesGastosDiv.classList.toggle('active');
            detalhesGanhosDiv.classList.remove('active'); // Garante que apenas um esteja aberto
        }
    }

    function atualizarTudo() {
      listarClientes();
      listarPedidos();
      filtrarDespesas(); // Chama este para a lista de despesas inicial
      atualizarFinanceiro(); // Chama este para o financeiro
      listarProdutos();
      listarHistorico();
    }
  </script>
</body>
</html>
